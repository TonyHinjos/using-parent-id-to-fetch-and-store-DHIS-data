Ext.onReady(function(){Ext.define("Ext.ux.button.ColorButton",{extend:"Ext.button.Button",alias:"widget.colorbutton",width:109,height:22,defaultValue:null,value:"f1f1f1",getValue:function(){return this.value},setValue:function(i){this.value=i;if(Ext.isDefined(this.getEl())){this.getEl().dom.style.background="#"+i}},reset:function(){this.setValue(this.defaultValue)},menu:{},menuHandler:function(){},initComponent:function(){var i=this;this.defaultValue=this.value;this.menu=Ext.create("Ext.menu.Menu",{showSeparator:false,items:{xtype:"colorpicker",closeAction:"hide",listeners:{select:function(k,j){i.setValue(j);i.menu.hide();i.menuHandler(k,j)}}}});this.callParent()},listeners:{render:function(){this.setValue(this.value)}}});Ext.define("Ext.ux.layout.component.form.MultiSelect",{extend:"Ext.layout.component.field.Field",alias:["layout.multiselectfield"],type:"multiselectfield",defaultHeight:200,sizeBodyContents:function(j,i){var k=this;if(!Ext.isNumber(i)){i=k.defaultHeight}k.owner.panel.setSize(j,i)}});Ext.define("Ext.ux.form.MultiSelect",{extend:"Ext.form.field.Base",alternateClassName:"Ext.ux.Multiselect",alias:["widget.multiselect","widget.multiselectfield"],uses:["Ext.view.BoundList","Ext.form.FieldSet","Ext.ux.layout.component.form.MultiSelect","Ext.view.DragZone","Ext.view.DropZone"],ddReorder:false,appendOnly:false,displayField:"text",allowBlank:true,minSelections:0,maxSelections:Number.MAX_VALUE,blankText:"This field is required",minSelectionsText:"Minimum {0} item(s) required",maxSelectionsText:"Maximum {0} item(s) allowed",delimiter:",",componentLayout:"multiselectfield",fieldBodyCls:Ext.baseCSSPrefix+"form-multiselect-body",initComponent:function(){var i=this;i.bindStore(i.store,true);if(i.store.autoCreated){i.valueField=i.displayField="field1";if(!i.store.expanded){i.displayField="field2"}}if(!Ext.isDefined(i.valueField)){i.valueField=i.displayField}i.callParent()},bindStore:function(i,k){var l=this,m=l.store,j=l.boundList;if(m&&!k&&m!==i&&m.autoDestroy){m.destroy()}l.store=i?Ext.data.StoreManager.lookup(i):null;if(j){j.bindStore(i||null)}},onRender:function(m,i){var n=this,j,l,k;n.callParent(arguments);l=n.boundList=Ext.create("Ext.view.BoundList",{multiSelect:true,store:n.store,displayField:n.displayField,border:false});k=l.getSelectionModel();n.mon(k,{selectionChange:n.onSelectionChange,scope:n});j=n.panel=Ext.create("Ext.panel.Panel",{title:n.listTitle,tbar:n.tbar,items:[l],renderTo:n.bodyEl,layout:"fit"});j.ownerCt=n;n.setRawValue(n.rawValue)},getSubTplMarkup:function(){return""},afterRender:function(){var i=this;i.callParent();if(i.ddReorder&&!i.dragGroup&&!i.dropGroup){i.dragGroup=i.dropGroup="MultiselectDD-"+Ext.id()}if(i.draggable||i.dragGroup){i.dragZone=Ext.create("Ext.view.DragZone",{view:i.boundList,ddGroup:i.dragGroup,dragText:"{0} Item{1}"})}if(i.droppable||i.dropGroup){i.dropZone=Ext.create("Ext.view.DropZone",{view:i.boundList,ddGroup:i.dropGroup,handleNodeDrop:function(p,o,j){var k=this.view,m=k.getStore(),l=p.records,n;p.view.store.remove(l);n=m.indexOf(o);if(j==="after"){n++}m.insert(n,l);k.getSelectionModel().select(l)}})}},onSelectionChange:function(){this.checkChange()},clearValue:function(){this.setValue([])},getSubmitValue:function(){var j=this,i=j.delimiter,k=j.getValue();return Ext.isString(i)?k.join(i):k},getRawValue:function(){var j=this,i=j.boundList;if(i){j.rawValue=Ext.Array.map(i.getSelectionModel().getSelection(),function(k){return k.get(j.valueField)})}return j.rawValue},setRawValue:function(k){var j=this,i=j.boundList,l;k=Ext.Array.from(k);j.rawValue=k;if(i){l=[];Ext.Array.forEach(k,function(o){var n,m=j.store.findRecord(j.valueField,o,n,n,true,true);if(m){l.push(m)}});i.getSelectionModel().select(l,false,true)}return k},valueToRaw:function(i){return i},isEqual:function(n,m){var k=Ext.Array.from,l,j;n=k(n);m=k(m);j=n.length;if(j!==m.length){return false}for(l=0;l<j;l++){if(m[l]!==n[l]){return false}}return true},getErrors:function(j){var i=this,k=Ext.String.format,m=i.callParent(arguments),l;j=Ext.Array.from(j||i.getValue());l=j.length;if(!i.allowBlank&&l<1){m.push(i.blankText)}if(l<this.minSelections){m.push(k(i.minSelectionsText,i.minSelections))}if(l>this.maxSelections){m.push(k(i.maxSelectionsText,i.maxSelections))}return m},onDisable:function(){this.callParent();this.disabled=true;this.updateReadOnly()},onEnable:function(){this.callParent();this.disabled=false;this.updateReadOnly()},setReadOnly:function(i){this.readOnly=i;this.updateReadOnly()},updateReadOnly:function(){var j=this,i=j.boundList,k=j.readOnly||j.disabled;if(i){i.getSelectionModel().setLocked(k)}},onDestroy:function(){Ext.destroyMembers(this,"panel","boundList","dragZone","dropZone");this.callParent()}});OpenLayers.Util.OSM={};OpenLayers.Util.OSM.MISSING_TILE_URL="http://www.openstreetmap.org/openlayers/img/404.png";OpenLayers.Util.OSM.originalOnImageLoadError=OpenLayers.Util.onImageLoadError;OpenLayers.Util.onImageLoadError=function(){if(this.src.match(/^http:\/\/[abc]\.[a-z]+\.openstreetmap\.org\//)){this.src=OpenLayers.Util.OSM.MISSING_TILE_URL}else{if(this.src.match(/^http:\/\/[def]\.tah\.openstreetmap\.org\//)){}else{OpenLayers.Util.OSM.originalOnImageLoadError}}};OpenLayers.Layer.OSM.Mapnik=OpenLayers.Class(OpenLayers.Layer.OSM,{initialize:function(k,l){var i=["http://a.tile.openstreetmap.org/${z}/${x}/${y}.png","http://b.tile.openstreetmap.org/${z}/${x}/${y}.png","http://c.tile.openstreetmap.org/${z}/${x}/${y}.png"];l=OpenLayers.Util.extend({numZoomLevels:19,buffer:0,transitionEffect:"resize"},l);var j=[k,i,l];OpenLayers.Layer.OSM.prototype.initialize.apply(this,j)},CLASS_NAME:"OpenLayers.Layer.OSM.Mapnik"});OpenLayers.Layer.OSM.Osmarender=OpenLayers.Class(OpenLayers.Layer.OSM,{initialize:function(k,l){var i=["http://a.tah.openstreetmap.org/Tiles/tile/${z}/${x}/${y}.png","http://b.tah.openstreetmap.org/Tiles/tile/${z}/${x}/${y}.png","http://c.tah.openstreetmap.org/Tiles/tile/${z}/${x}/${y}.png"];l=OpenLayers.Util.extend({numZoomLevels:18,buffer:0,transitionEffect:"resize"},l);var j=[k,i,l];OpenLayers.Layer.OSM.prototype.initialize.apply(this,j)},CLASS_NAME:"OpenLayers.Layer.OSM.Osmarender"});OpenLayers.Layer.OSM.CycleMap=OpenLayers.Class(OpenLayers.Layer.OSM,{initialize:function(k,l){var i=["http://a.tile.opencyclemap.org/cycle/${z}/${x}/${y}.png","http://b.tile.opencyclemap.org/cycle/${z}/${x}/${y}.png","http://c.tile.opencyclemap.org/cycle/${z}/${x}/${y}.png"];l=OpenLayers.Util.extend({numZoomLevels:19,buffer:0,transitionEffect:"resize"},l);var j=[k,i,l];OpenLayers.Layer.OSM.prototype.initialize.apply(this,j)},CLASS_NAME:"OpenLayers.Layer.OSM.CycleMap"});OpenLayers.Control.Circle=OpenLayers.Class(OpenLayers.Control,{feature:null,layer:null,radius:5,origin:null,sides:40,angle:null,snapAngle:null,dragControl:null,initialize:function(i){OpenLayers.Control.prototype.initialize.apply(this,arguments)},activate:function(){var j=OpenLayers.Control.prototype.activate.call(this);if(j){var i={displayInLayerSwitcher:false,calculateInRange:function(){return true}};this.map.addLayer(this.layer)}return j},deactivate:function(){var i=OpenLayers.Control.prototype.deactivate.call(this);if(i){if(this.layer.map!=null){this.layer.destroy(false);if(this.feature){this.feature.destroy()}}this.layer=null;this.feature=null}return i},createGeometry:function(){this.angle=Math.PI*((1/this.sides)-(1/2));if(this.snapAngle){this.angle+=this.snapAngle*(Math.PI/180)}this.feature.geometry=OpenLayers.Geometry.Polygon.createRegularPolygon(this.origin,this.radius,this.sides,this.snapAngle)},modifyGeometry:function(){var k,n,i,j;var m=this.feature.geometry.components[0];if(m.components.length!=(this.sides+1)){this.createGeometry();m=this.feature.geometry.components[0]}for(var l=0;l<this.sides;++l){j=m.components[l];k=this.angle+(l*2*Math.PI/this.sides);j.x=this.origin.x+(this.radius*Math.cos(k));j.y=this.origin.y+(this.radius*Math.sin(k));j.clearBounds()}},updateCircle:function(i,j){this.origin=new OpenLayers.Geometry.Point(i.lon,i.lat);this.radius=j*1;if(!this.feature){this.feature=new OpenLayers.Feature.Vector();this.createGeometry();this.layer.addFeatures([this.feature],{silent:true})}else{this.modifyGeometry()}this.layer.drawFeature(this.feature,this.style)},CLASS_NAME:"Meteorage.Circle"});OpenLayers.Control.newSelectFeature=OpenLayers.Class(OpenLayers.Control,{multipleKey:null,toggleKey:null,multiple:false,clickout:true,toggle:false,hover:false,onSelect:function(){},onUnselect:function(){},onHoverSelect:function(){},onHoverUnselect:function(){},onClickSelect:function(){},onClickUnselect:function(){},geometryTypes:null,layer:null,callbacks:null,selectStyle:null,renderIntent:"select",handler:null,initialize:function(k,j){OpenLayers.Control.prototype.initialize.apply(this,[j]);this.layer=k;this.callbacks=OpenLayers.Util.extend({click:this.clickFeature,clickout:this.clickoutFeature,over:this.overFeature,out:this.outFeature},this.callbacks);var i={geometryTypes:this.geometryTypes};this.handler=new OpenLayers.Handler.Feature(this,k,this.callbacks,i)},unselectAll:function(j){var l;for(var k=this.layer.selectedFeatures.length-1;k>=0;--k){l=this.layer.selectedFeatures[k];if(!j||j.except!=l){this.unselect(l,"click")}}},clickFeature:function(i){if((this.onSelect.name!=""||this.onClickSelect.name!="")&&!this.hover){var j=(OpenLayers.Util.indexOf(this.layer.selectedFeatures,i)>-1);if(j){if(this.toggleSelect()){this.unselect(i)}else{if(!this.multipleSelect()){this.unselectAll({except:i})}}}else{if(!this.multipleSelect()){this.unselectAll({except:i})}}this.select(i,"click")}},multipleSelect:function(){return this.multiple||this.handler.evt[this.multipleKey]},toggleSelect:function(){return this.toggle||this.handler.evt[this.toggleKey]},clickoutFeature:function(i){if(((this.onClickUnselect.name!=""||this.onHoverSelect.name=="")&&!this.hover)&&this.clickout){this.unselectAll()}},overFeature:function(i){if((this.onHoverSelect.name!=""||this.hover)&&(OpenLayers.Util.indexOf(this.layer.selectedFeatures,i)==-1)){this.select(i,"hover")}},outFeature:function(i){if(this.onHoverUnselect.name!=""||this.hover){this.unselect(i,"hover")}},select:function(k,i){this.layer.selectedFeatures.push(k);var j=this.selectStyle||this.renderIntent;this.layer.drawFeature(k,j);this.layer.events.triggerEvent("featureselected",{feature:k});switch(i){case"hover":this.onHoverSelect(k);break;case"click":if(this.onClickSelect.name!=""){this.onClickSelect(k)}else{if(this.onSelect.name!=""){this.onSelect(k)}}break;default:this.onSelect(k);break}},unselect:function(j,i){this.layer.drawFeature(j,"default");OpenLayers.Util.removeItem(this.layer.selectedFeatures,j);this.layer.events.triggerEvent("featureunselected",{feature:j});switch(i){case"hover":this.onHoverUnselect(j);break;case"click":if(this.onClickUnselect.name!=""){this.onClickUnselect(j)}else{if(this.onUnselect.name!=""){this.onUnselect(j)}}break;default:this.onUnselect(j);break}},setMap:function(i){this.handler.setMap(i);OpenLayers.Control.prototype.setMap.apply(this,arguments)},CLASS_NAME:"OpenLayers.Control.newSelectFeature"});Ext.define("GeoExt.data.LayerModel",{alternateClassName:"GeoExt.data.LayerRecord",extend:"Ext.data.Model",requires:["Ext.data.proxy.Memory","Ext.data.reader.Json"],alias:"model.gx_layer",statics:{createFromLayer:function(i){return this.proxy.reader.readRecords([i]).records[0]}},fields:["id",{name:"title",type:"string",mapping:"name"},{name:"legendURL",type:"string",mapping:"metadata.legendURL"},{name:"hideTitle",type:"bool",mapping:"metadata.hideTitle"},{name:"hideInLegend",type:"bool",mapping:"metadata.hideInLegend"}],proxy:{type:"memory",reader:{type:"json"}},getLayer:function(){return this.raw}});Ext.define("GeoExt.data.LayerStore",{requires:["GeoExt.data.LayerModel"],extend:"Ext.data.Store",model:"GeoExt.data.LayerModel",statics:{MAP_TO_STORE:1,STORE_TO_MAP:2},map:null,constructor:function(i){var l=this;i=Ext.apply({},i);var k=(GeoExt.MapPanel&&i.map instanceof GeoExt.MapPanel)?i.map.map:i.map;delete i.map;if(i.layers){i.data=i.layers}delete i.layers;var j={initDir:i.initDir};delete i.initDir;l.callParent([i]);if(k){this.bind(k,j)}},bind:function(k,j){var i=this;if(i.map){return}i.map=k;j=Ext.apply({},j);var m=j.initDir;if(j.initDir==undefined){m=GeoExt.data.LayerStore.MAP_TO_STORE|GeoExt.data.LayerStore.STORE_TO_MAP}var l=k.layers.slice(0);if(m&GeoExt.data.LayerStore.STORE_TO_MAP){i.each(function(n){i.map.addLayer(n.getLayer())},i)}if(m&GeoExt.data.LayerStore.MAP_TO_STORE){i.loadRawData(l,true)}k.events.on({changelayer:i.onChangeLayer,addlayer:i.onAddLayer,removelayer:i.onRemoveLayer,scope:i});i.on({load:i.onLoad,clear:i.onClear,add:i.onAdd,remove:i.onRemove,update:i.onUpdate,scope:i});i.data.on({replace:i.onReplace,scope:i});i.fireEvent("bind",i,k)},unbind:function(){var i=this;if(i.map){i.map.events.un({changelayer:i.onChangeLayer,addlayer:i.onAddLayer,removelayer:i.onRemoveLayer,scope:i});i.un("load",i.onLoad,i);i.un("clear",i.onClear,i);i.un("add",i.onAdd,i);i.un("remove",i.onRemove,i);i.data.un("replace",i.onReplace,i);i.map=null}},onChangeLayer:function(i){var k=i.layer;var m=this.findBy(function(o,n){return o.getLayer()===k});if(m>-1){var j=this.getAt(m);if(i.property==="order"){if(!this._adding&&!this._removing){var l=this.map.getLayerIndex(k);if(l!==m){this._removing=true;this.remove(j);delete this._removing;this._adding=true;this.insert(l,[j]);delete this._adding}}}else{if(i.property==="name"){j.set("title",k.name)}else{this.fireEvent("update",this,j,Ext.data.Record.EDIT)}}}},onAddLayer:function(i){var k=this;if(!k._adding){k._adding=true;var j=k.proxy.reader.read(i.layer);k.add(j.records);delete k._adding}},onRemoveLayer:function(j){if(this.map.unloadDestroy){if(!this._removing){var i=j.layer;this._removing=true;this.remove(this.getByLayer(i));delete this._removing}}else{this.unbind()}},onLoad:function(o,i,k){if(k){if(!Ext.isArray(i)){i=[i]}if(!this._addRecords){this._removing=true;for(var m=this.map.layers.length-1;m>=0;m--){this.map.removeLayer(this.map.layers[m])}delete this._removing}var j=i.length;if(j>0){var l=new Array(j);for(var n=0;n<j;n++){l[n]=i[n].getLayer()}this._adding=true;this.map.addLayers(l);delete this._adding}}delete this._addRecords},onClear:function(j){this._removing=true;for(var i=this.map.layers.length-1;i>=0;i--){this.map.removeLayer(this.map.layers[i])}delete this._removing},onAdd:function(i,j,m){if(!this._adding){this._adding=true;var k;for(var l=j.length-1;l>=0;--l){k=j[l].getLayer();this.map.addLayer(k);if(m!==this.map.layers.length-1){this.map.setLayerIndex(k,m)}}delete this._adding}},onRemove:function(i,j,l){if(!this._removing){var k=j.getLayer();if(this.map.getLayer(k.id)!=null){this._removing=true;this.removeMapLayer(j);delete this._removing}}},onUpdate:function(m,j,i){if(i===Ext.data.Record.EDIT){if(j.modified&&j.modified.title){var l=j.getLayer();var k=j.get("title");if(k!==l.name){l.setName(k)}}}},removeMapLayer:function(i){this.map.removeLayer(i.getLayer())},onReplace:function(k,j,i){this.removeMapLayer(j)},getByLayer:function(i){var j=this.findBy(function(k){return k.getLayer()===i});if(j>-1){return this.getAt(j)}},destroy:function(){var i=this;i.unbind();i.callParent()},loadRecords:function(j,i){if(i&&i.addRecords){this._addRecords=true}this.callParent(arguments)}});Ext.define("GeoExt.panel.Map",{extend:"Ext.panel.Panel",requires:["GeoExt.data.LayerStore"],alias:"widget.gx_mappanel",alternateClassName:"GeoExt.MapPanel",statics:{guess:function(){var i=Ext.ComponentQuery.query("gx_mappanel");return((i&&i.length>0)?i[0]:null)}},center:null,zoom:null,extent:null,prettyStateKeys:false,map:null,layers:null,stateEvents:["aftermapmove","afterlayervisibilitychange","afterlayeropacitychange","afterlayerorderchange","afterlayernamechange","afterlayeradd","afterlayerremove"],initComponent:function(){if(!(this.map instanceof OpenLayers.Map)){this.map=new OpenLayers.Map(Ext.applyIf(this.map||{},{allOverlays:true}))}var i=this.layers;if(!i||i instanceof Array){this.layers=Ext.create("GeoExt.data.LayerStore",{layers:i,map:this.map.layers.length>0?this.map:null})}if(Ext.isString(this.center)){this.center=OpenLayers.LonLat.fromString(this.center)}else{if(Ext.isArray(this.center)){this.center=new OpenLayers.LonLat(this.center[0],this.center[1])}}if(Ext.isString(this.extent)){this.extent=OpenLayers.Bounds.fromString(this.extent)}else{if(Ext.isArray(this.extent)){this.extent=OpenLayers.Bounds.fromArray(this.extent)}}this.callParent(arguments);this.on("resize",this.onResize,this);this.on("afterlayout",function(){if(typeof this.map.getViewport==="function"){this.items.each(function(j){if(typeof j.addToMapPanel==="function"){j.getEl().appendTo(this.map.getViewport())}},this)}},this);this.map.events.on({moveend:this.onMoveend,changelayer:this.onChangelayer,addlayer:this.onAddlayer,removelayer:this.onRemovelayer,scope:this})},onMoveend:function(i){this.fireEvent("aftermapmove",this,this.map,i)},onChangelayer:function(i){var j=this.map;if(i.property){if(i.property==="visibility"){this.fireEvent("afterlayervisibilitychange",this,j,i)}else{if(i.property==="order"){this.fireEvent("afterlayerorderchange",this,j,i)}else{if(i.property==="nathis"){this.fireEvent("afterlayernathischange",this,j,i)}else{if(i.property==="opacity"){this.fireEvent("afterlayeropacitychange",this,j,i)}}}}}},onAddlayer:function(){this.fireEvent("afterlayeradd")},onRemovelayer:function(){this.fireEvent("afterlayerremove")},onResize:function(){var i=this.map;if(this.body.dom!==i.div){i.render(this.body.dom);this.layers.bind(i);if(i.layers.length>0){this.setInitialExtent()}else{this.layers.on("add",this.setInitialExtent,this,{single:true})}}else{i.updateSize()}},setInitialExtent:function(){var i=this.map;if(!i.getCenter()){if(this.center||this.zoom){i.setCenter(this.center,this.zoom)}else{if(this.extent instanceof OpenLayers.Bounds){i.zoomToExtent(this.extent,true)}else{i.zoomToMaxExtent()}}}},getState:function(){var m=this,k=m.map,l=m.callParent(arguments)||{},i;if(!k){return}var j=k.getCenter();j&&Ext.applyIf(l,{x:j.lon,y:j.lat,zoom:k.getZoom()});m.layers.each(function(n){i=n.getLayer();layerId=this.prettyStateKeys?n.get("title"):n.get("id");l=m.addPropertyToState(l,"visibility_"+layerId,i.getVisibility());l=m.addPropertyToState(l,"opacity_"+layerId,(i.opacity===null)?1:i.opacity)},m);return l},applyState:function(r){var i=this;map=i.map;i.center=new OpenLayers.LonLat(r.x,r.y);i.zoom=r.zoom;var m,p,l,o,q,k;var n=map.layers;for(m=0,p=n.length;m<p;m++){l=n[m];o=i.prettyStateKeys?l.name:l.id;q=r["visibility_"+o];if(q!==undefined){q=(/^true$/i).test(q);if(l.isBaseLayer){if(q){map.setBaseLayer(l)}}else{l.setVisibility(q)}}k=r["opacity_"+o];if(k!==undefined){l.setOpacity(k)}}},onBeforeAdd:function(i){if(Ext.isFunction(i.addToMapPanel)){i.addToMapPanel(this)}this.callParent(arguments)},beforeDestroy:function(){if(this.map&&this.map.events){this.map.events.un({moveend:this.onMoveend,changelayer:this.onChangelayer,scope:this})}if(!this.initialConfig.map||!(this.initialConfig.map instanceof OpenLayers.Map)){if(this.map&&this.map.destroy){this.map.destroy()}}delete this.map;this.callParent(arguments)}});Ext.define("GeoExt.tree.Column",{extend:"Ext.tree.Column",alias:"widget.gx_treecolumn",initComponent:function(){var i=this;i.callParent();var j=i.renderer;this.renderer=function(l,p,q,m,k,o,r){var n=[j(l,p,q,m,k,o,r)];if(q.get("checkedGroup")){n[0]=n[0].replace(/class="([^-]+)-tree-checkbox([^"]+)?"/,'class="$1-tree-checkbox$2 gx-tree-radio"')}n.push('<div class="gx-tree-component gx-tree-component-off" id="tree-record-'+q.id+'"></div>');if(q.uiProvider&&q.uiProvider instanceof "string"){}return n.join("")}},defaultRenderer:function(i){return i}});Ext.define("GeoExt.tree.View",{extend:"Ext.tree.View",alias:"widget.gx_treeview",initComponent:function(){var i=this;i.on("itemupdate",this.onItem,this);i.on("itemadd",this.onItem,this);i.on("createchild",this.createChild,this);return i.callParent(arguments)},onItem:function(j,n,k,i){var l=this;if(!(j instanceof Array)){j=[j]}for(var m=0;m<j.length;m++){this.onNodeRendered(j[m])}},onNodeRendered:function(k){var i=this;var j=Ext.get("tree-record-"+k.id);if(!j){return}if(k.get("layer")){i.fireEvent("createchild",j,k)}if(k.hasChildNodes()){k.eachChild(function(l){i.onNodeRendered(l)},i)}},createChild:function(i,k){var j=k.get("component");if(j){cmpObj=Ext.ComponentManager.create(j);cmpObj.render(i);i.removeCls("gx-tree-component-off")}}});Ext.define("GeoExt.tree.LayerNode",{extend:"Ext.AbstractPlugin",alias:"plugin.gx_layer",init:function(i){this.target=i;var j=i.get("layer");i.set("checked",j.getVisibility());if(!i.get("checkedGroup")&&j.isBaseLayer){i.set("checkedGroup","gx_baselayer")}i.set("fixedText",!!i.text);i.set("leaf",true);if(!i.get("iconCls")){i.set("iconCls","gx-tree-layer-icon")}i.on("afteredit",this.onAfterEdit,this);j.events.on({visibilitychanged:this.onLayerVisibilityChanged,scope:this})},onAfterEdit:function(k,j){var i=this;if(~Ext.Array.indexOf(j,"checked")){i.onCheckChange()}},onLayerVisibilityChanged:function(){if(!this._visibilityChanging){this.target.set("checked",this.target.get("layer").getVisibility())}},onCheckChange:function(){var k=this.target,i=this.target.get("checked");if(i!=k.get("layer").getVisibility()){k._visibilityChanging=true;var j=k.get("layer");if(i&&j.isBaseLayer&&j.map){j.map.setBaseLayer(j)}else{j.setVisibility(i)}delete k._visibilityChanging}}});Ext.define("GeoExt.tree.LayerLoader",{extend:"Ext.util.Observable",requires:["GeoExt.tree.LayerNode"],store:null,filter:function(i){return i.getLayer().displayInLayerSwitcher===true},baseAttrs:null,load:function(i){if(this.fireEvent("beforeload",this,i)){this.removeStoreHandlers();while(i.firstChild){i.removeChild(i.firstChild)}if(!this.store){this.store=GeoExt.MapPanel.guess().layers}this.store.each(function(j){this.addLayerNode(i,j)},this);this.addStoreHandlers(i);this.fireEvent("load",this,i)}},onStoreAdd:function(i,j,o,l){if(!this._reordering){var k=l.get("container").recordIndexToNodeIndex(o+j.length-1,l);for(var n=0,m=j.length;n<m;++n){this.addLayerNode(l,j[n],k)}}},onStoreRemove:function(j,i){if(!this._reordering){this.removeLayerNode(i,j)}},addLayerNode:function(l,j,i){i=i||0;if(this.filter(j)===true){var m=j.getLayer();var k=this.createNode({plugins:[{ptype:"gx_layer"}],layer:m,text:m.name,listeners:{move:this.onChildMove,scope:this}});if(i!==undefined){l.insertChild(i,k)}else{l.appendChild(k)}l.getChildAt(i).on("move",this.onChildMove,this)}},removeLayerNode:function(i,j){if(this.filter(j)===true){var k=i.findChildBy(function(l){return l.get("layer")==j.getLayer()});if(k){k.un("move",this.onChildMove,this);k.remove()}}},onChildMove:function(v,n,m,q){var p=this,r=p.store.getByLayer(v.get("layer")),w=m.get("container"),s=w.loader;p._reordering=true;if(s instanceof p.self&&p.store===s.store){s._reordering=true;p.store.remove(r);var x;if(m.childNodes.length>1){var o=(q===0)?q+1:q-1;x=p.store.findBy(function(i){return m.childNodes[o].get("layer")===i.getLayer()});if(q===0){x++}}else{if(n.parentNode===m.parentNode){var u=m;do{u=u.previousSibling}while(u&&!(u.get("container") instanceof w.self&&u.lastChild));if(u){x=p.store.findBy(function(i){return u.lastChild.get("layer")===i.getLayer()})}else{var t=m;do{t=t.nextSibling}while(t&&!(t.get("container") instanceof w.self&&t.firstChild));if(t){x=p.store.findBy(function(i){return t.firstChild.get("layer")===i.getLayer()})}x++}}}if(x!==undefined){p.store.insert(x,[r])}else{p.store.insert(oldRecordIndex,[r])}delete s._reordering}delete p._reordering},addStoreHandlers:function(i){if(!this._storeHandlers){this._storeHandlers={add:function(m,k,l){this.onStoreAdd(m,k,l,i)},remove:function(l,k){this.onStoreRemove(k,i)}};for(var j in this._storeHandlers){this.store.on(j,this._storeHandlers[j],this)}}},removeStoreHandlers:function(){if(this._storeHandlers){for(var i in this._storeHandlers){this.store.un(i,this._storeHandlers[i],this)}delete this._storeHandlers}},createNode:function(i){if(this.baseAttrs){Ext.apply(i,this.baseAttrs)}return i},destroy:function(){this.removeStoreHandlers()}});Ext.define("GeoExt.tree.LayerContainer",{extend:"Ext.AbstractPlugin",requires:["GeoExt.tree.LayerLoader"],alias:"plugin.gx_layercontainer",defaultText:"Layers",init:function(k){var i=this;var j=i.loader;i.loader=(j&&j instanceof GeoExt.tree.LayerLoader)?j:new GeoExt.tree.LayerLoader(j);k.set("container",i);if(!k.get("text")){k.set("text",i.defaultText);k.commit()}i.loader.load(k)},recordIndexToNodeIndex:function(p,l){var m=this;var i=m.loader.store;var n=i.getCount();var j=l.childNodes.length;var k=-1;for(var o=n-1;o>=0;--o){if(m.loader.filter(i.getAt(o))===true){++k;if(p===o||k>j-1){break}}}return k}});Ext.define("GeoExt.tree.BaseLayerContainer",{extend:"GeoExt.tree.LayerContainer",alias:"plugin.gx_baselayercontainer",defaultText:"Base Layers",init:function(k){var i=this;var j=i.loader;i.loader=Ext.applyIf(j||{},{baseAttrs:Ext.applyIf((j&&j.baseAttrs)||{},{iconCls:"gx-tree-baselayer-icon",checkedGroup:"baselayer"}),filter:function(m){var l=m.getLayer();return l.displayInLayerSwitcher===true&&l.isBaseLayer===true}});i.callParent(arguments)}});Ext.define("GeoExt.tree.Panel",{extend:"Ext.tree.Panel",alias:"widget.gx_treepanel",requires:["GeoExt.tree.Column","GeoExt.tree.View"],viewType:"gx_treeview",initComponent:function(){var i=this;if(!i.columns){if(i.initialConfig.hideHeaders===undefined){i.hideHeaders=true}i.addCls(Ext.baseCSSPrefix+"autowidth-table");i.columns=[{xtype:"gx_treecolumn",text:"Name",width:Ext.isIE6?null:10000,dataIndex:i.displayField}]}i.callParent()}});Ext.Ajax.method="GET";GIS={core:{instances:[]},i18n:{},isDebug:false,logg:[]};GIS.core.getOLMap=function(j){var k,i;i=function(m,o){var n,l;n=new OpenLayers.Control.Button({displayClass:"olControlButton",trigger:function(){o.call(j.olmap)}});l=new OpenLayers.Control.Panel({defaultControl:n});l.addControls([n]);k.addControl(l);l.div.className+=" "+m;l.div.childNodes[0].className+=" "+m+"Button"};k=new OpenLayers.Map({controls:[new OpenLayers.Control.Navigation({zoomWheelEnabled:false,documentDrag:true}),new OpenLayers.Control.MousePosition({prefix:'<span id="mouseposition" class="el-fontsize-10"><span class="text-mouseposition-lonlat">LON </span>',separator:'<span class="text-mouseposition-lonlat">,&nbsp;LAT </span>',suffix:'<div id="google-logo" name="http://www.google.com/intl/en-US_US/help/terms_maps.html" onclick="window.open(Ext.get(this).dom.attributes.name.nodeValue);"></div></span>'}),new OpenLayers.Control.Permalink(),new OpenLayers.Control.ScaleLine({geodesic:true,maxWidth:170,minWidth:100})],displayProjection:new OpenLayers.Projection("EPSG:4326"),maxExtent:new OpenLayers.Bounds(-20037508,-20037508,20037508,20037508),mouseMove:{},relocate:{}});k.events.register("mousemove",null,function(l){j.olmap.mouseMove.x=l.clientX;j.olmap.mouseMove.y=l.clientY});k.zoomToVisibleExtent=function(){j.util.map.zoomToVisibleExtent(this)};k.closeAllLayers=function(){j.layer.event.core.reset();j.layer.facility.core.reset();j.layer.boundary.core.reset();j.layer.thematic1.core.reset();j.layer.thematic2.core.reset();j.layer.thematic3.core.reset();j.layer.thematic4.core.reset()};i("zoomIn",k.zoomIn);i("zoomOut",k.zoomOut);i("zoomVisible",k.zoomToVisibleExtent);i("measure",function(){GIS.core.MeasureWindow(j).show()});return k};GIS.core.getLayers=function(j){var o={},k,m=["1","2","3","4"];if(window.google){o.googleStreets=new OpenLayers.Layer.Google("Google Streets",{numZoomLevels:20,animationEnabled:true,layerType:j.conf.finals.layer.type_base,layerOpacity:1,setLayerOpacity:function(i){if(i){this.layerOpacity=parseFloat(i)}this.setOpacity(this.layerOpacity)}});o.googleStreets.id="googleStreets";o.googleHybrid=new OpenLayers.Layer.Google("Google Hybrid",{type:google.maps.MapTypeId.HYBRID,numZoomLevels:20,animationEnabled:true,layerType:j.conf.finals.layer.type_base,layerOpacity:1,setLayerOpacity:function(i){if(i){this.layerOpacity=parseFloat(i)}this.setOpacity(this.layerOpacity)}});o.googleHybrid.id="googleHybrid"}o.openStreetMap=new OpenLayers.Layer.OSM.Mapnik("OpenStreetMap",{layerType:j.conf.finals.layer.type_base,layerOpacity:1,setLayerOpacity:function(i){if(i){this.layerOpacity=parseFloat(i)}this.setOpacity(this.layerOpacity)}});o.openStreetMap.id="openStreetMap";o.event=GIS.core.VectorLayer(j,"event",GIS.i18n.event_layer,{opacity:0.8});o.event.core=new mapfish.GeoStat.Event(j.olmap,{layer:o.event,gis:j});o.facility=GIS.core.VectorLayer(j,"facility",GIS.i18n.facility_layer,{opacity:1});o.facility.core=new mapfish.GeoStat.Facility(j.olmap,{layer:o.facility,gis:j});o.boundary=GIS.core.VectorLayer(j,"boundary",GIS.i18n.boundary_layer,{opacity:0.8});o.boundary.core=new mapfish.GeoStat.Boundary(j.olmap,{layer:o.boundary,gis:j});for(var l=0,n;l<m.length;l++){n=m[l];o["thematic"+n]=GIS.core.VectorLayer(j,"thematic"+n,GIS.i18n.thematic_layer+" "+n,{opacity:0.8});o["thematic"+n].layerCategory=j.conf.finals.layer.category_thematic,o["thematic"+n].core=new mapfish.GeoStat["Thematic"+n](j.olmap,{layer:o["thematic"+n],gis:j})}return o};GIS.core.createSelectHandlers=function(r,l){var t=!!GIS.app?(r.init.user.isAdmin?true:false):false,u={},n,i,k,j,m,q=r.conf.finals.dimension,s,p;i=function o(w){if(s){s.destroy()}s=Ext.create("Ext.window.Window",{cls:"gis-window-widget-feature gis-plugin",preventHeader:true,shadow:false,resizable:false,items:{html:w.attributes.label}});s.show();var z=r.viewport.eastRegion.getPosition()[0],y=r.viewport.centerRegion.getPosition()[0],x=y+((z-y)/2),v=r.viewport.centerRegion.getPosition()[1]+(GIS.app?32:0);s.setPosition(x-(s.getWidth()/2),v)};k=function o(v){s.destroy()};j=function o(D){var C,B,w,x,y,A=D.geometry.CLASS_NAME===r.conf.finals.openLayers.point_classname,z=D.attributes;B=function(){if(r.olmap.relocate.window){r.olmap.relocate.window.destroy()}r.olmap.relocate.window=Ext.create("Ext.window.Window",{title:"Relocate facility",layout:"fit",iconCls:"gis-window-title-icon-relocate",cls:"gis-container-default",setMinWidth:function(E){this.setWidth(this.getWidth()<E?E:this.getWidth())},items:{html:z.name,cls:"gis-container-inner"},bbar:["->",{xtype:"button",hideLabel:true,text:GIS.i18n.cancel,handler:function(){r.olmap.relocate.active=false;r.olmap.relocate.window.destroy();r.olmap.getViewport().style.cursor="auto"}}],listeners:{close:function(){r.olmap.relocate.active=false;r.olmap.getViewport().style.cursor="auto"}}});r.olmap.relocate.window.show();r.olmap.relocate.window.setMinWidth(220);r.util.gui.window.setPositionTopRight(r.olmap.relocate.window)};C=function(){Ext.Ajax.request({url:r.init.contextPath+r.conf.finals.url.path_module+"getFacilityInfo.action",params:{id:z.id},success:function(F){var E=Ext.decode(F.responseText);if(l.infrastructuralWindow){l.infrastructuralWindow.destroy()}l.infrastructuralWindow=Ext.create("Ext.window.Window",{title:GIS.i18n.information,layout:"column",iconCls:"gis-window-title-icon-information",cls:"gis-container-default",width:460,height:400,period:null,items:[{cls:"gis-container-inner",columnWidth:0.4,bodyStyle:"padding-right:4px",items:function(){var G=[];if(z.name){G.push({html:GIS.i18n.name,cls:"gis-panel-html-title"},{html:z.name,cls:"gis-panel-html"},{cls:"gis-panel-html-separator"})}if(E.pa){G.push({html:GIS.i18n.parent_unit,cls:"gis-panel-html-title"},{html:E.pa,cls:"gis-panel-html"},{cls:"gis-panel-html-separator"})}if(E.ty){G.push({html:GIS.i18n.type,cls:"gis-panel-html-title"},{html:E.ty,cls:"gis-panel-html"},{cls:"gis-panel-html-separator"})}if(E.co){G.push({html:GIS.i18n.code,cls:"gis-panel-html-title"},{html:E.co,cls:"gis-panel-html"},{cls:"gis-panel-html-separator"})}if(E.ad){G.push({html:GIS.i18n.address,cls:"gis-panel-html-title"},{html:E.ad,cls:"gis-panel-html"},{cls:"gis-panel-html-separator"})}if(E.em){G.push({html:GIS.i18n.email,cls:"gis-panel-html-title"},{html:E.em,cls:"gis-panel-html"},{cls:"gis-panel-html-separator"})}if(E.pn){G.push({html:GIS.i18n.phone_number,cls:"gis-panel-html-title"},{html:E.pn,cls:"gis-panel-html"},{cls:"gis-panel-html-separator"})}return G}()},{xtype:"form",cls:"gis-container-inner gis-form-widget",columnWidth:0.6,bodyStyle:"padding-left:4px",items:[{html:GIS.i18n.infrastructural_data,cls:"gis-panel-html-title"},{cls:"gis-panel-html-separator"},{xtype:"combo",fieldLabel:GIS.i18n.period,editable:false,valueField:"id",displayField:"name",forceSelection:true,width:255,labelWidth:70,store:r.store.infrastructuralPeriodsByType,lockPosition:false,listeners:{select:function(){n=this.getValue();l.widget.infrastructuralDataElementValuesStore.load({params:{periodId:n,organisationUnitId:z.internalId}})}}},{cls:"gis-panel-html-separator"},{xtype:"grid",cls:"gis-grid",height:300,width:255,scroll:"vertical",columns:[{id:"dataElementName",text:"Data element",dataIndex:"dataElementName",sortable:true,width:195},{id:"value",header:"Value",dataIndex:"value",sortable:true,width:60}],disableSelection:true,store:l.widget.infrastructuralDataElementValuesStore}]}],listeners:{show:function(){if(n){this.down("combo").setValue(n);infrastructuralDataElementValuesStore.load({params:{periodId:n,organisationUnitId:z.internalId}})}}}});l.infrastructuralWindow.show();r.util.gui.window.setPositionTopRight(l.infrastructuralWindow)}})};w=function(I,G,H){var F=Ext.clone(l.core.view),E;F.parentGraphMap={};F.parentGraphMap[I]=G;F.rows=[{dimension:q.organisationUnit.objectName,items:[{id:I},{id:"LEVEL-"+H}]}];if(F){E=l.core.getLoader();E.updateGui=true;E.zoomToVisibleExtent=true;E.hideMask=true;E.load(F)}};var v=[Ext.create("Ext.menu.Item",{text:"Float up",iconCls:"gis-menu-item-icon-float",cls:"gis-plugin",disabled:!z.hasCoordinatesUp,handler:function(){w(z.grandParentId,z.grandParentParentGraph,parseInt(z.level)-1)}}),Ext.create("Ext.menu.Item",{text:"Drill down",iconCls:"gis-menu-item-icon-drill",cls:"gis-menu-item-first gis-plugin",disabled:!z.hasCoordinatesDown,handler:function(){w(z.id,z.parentGraph,parseInt(z.level)+1)}})];if(t&&A){v.push({xtype:"menuseparator"});v.push(Ext.create("Ext.menu.Item",{text:GIS.i18n.relocate,iconCls:"gis-menu-item-icon-relocate",disabled:!r.init.user.isAdmin,handler:function(E){r.olmap.relocate.active=true;r.olmap.relocate.feature=D;r.olmap.getViewport().style.cursor="crosshair";B()}}));v.push(Ext.create("Ext.menu.Item",{text:"Swap lon/lat",iconCls:"gis-menu-item-icon-relocate",disabled:!r.init.user.isAdmin,handler:function(E){var G=D.attributes.id,F=Ext.clone(D.geometry).transform("EPSG:900913","EPSG:4326");if(Ext.isNumber(F.x)&&Ext.isNumber(F.y)&&r.init.user.isAdmin){Ext.Ajax.request({url:r.init.contextPath+"/api/organisationUnits/"+G+".json?links=false",success:function(H){var I=Ext.decode(H.responseText);I.coordinates="["+F.y.toFixed(5)+","+F.x.toFixed(5)+"]";Ext.Ajax.request({url:r.init.contextPath+"/api/metaData?preheatCache=false",method:"POST",headers:{"Content-Type":"application/json"},params:Ext.encode({organisationUnits:[I]}),success:function(K){var J=D.geometry.x,L=D.geometry.y;delete D.geometry.bounds;D.geometry.x=L;D.geometry.y=J;l.redraw();console.log(D.attributes.name+" relocated to "+I.coordinates)}})}})}}}));v.push(Ext.create("Ext.menu.Item",{text:GIS.i18n.show_information_sheet,iconCls:"gis-menu-item-icon-information",handler:function(E){if(r.store.infrastructuralPeriodsByType.isLoaded){C()}else{r.store.infrastructuralPeriodsByType.load({params:{name:r.init.systemSettings.infrastructuralPeriodType},callback:function(){C()}})}}}))}v[v.length-1].addCls("gis-menu-item-last");x=new Ext.menu.Menu({baseCls:"gis-plugin",shadow:false,showSeparator:false,defaults:{bodyStyle:"padding-right:6px"},items:v,listeners:{afterrender:function(){this.getEl().addCls("gis-toolbar-btn-menu")}}});x.showAt([r.olmap.mouseMove.x,r.olmap.mouseMove.y])};u={onHoverSelect:i,onHoverUnselect:k,onClickSelect:j};if(l.id==="event"){u.onClickSelect=function o(D){var z=["label","value","nameColumnMap","psi","ps","longitude","latitude","eventdate","ou","oucode","ouname"],x=D.attributes,v=x.nameColumnMap,y='<table class="padding1">',B=' style="font-weight:bold; padding-right:10px; vertical-align:top"',w=' style="max-width:170px"',A;y+="<tr><td"+B+">"+v.ou+"</td><td"+w+">"+x.ouname+"</td></tr>";y+="<tr><td"+B+">"+v.eventdate+"</td><td"+w+">"+x.eventdate+"</td></tr>";y+="<tr><td"+B+">"+v.longitude+"</td><td"+w+">"+x.longitude+"</td></tr>";y+="<tr><td"+B+">"+v.latitude+"</td><td"+w+">"+x.latitude+"</td></tr>";for(var C in x){if(x.hasOwnProperty(C)&&!Ext.Array.contains(z,C)){y+="<tr><td"+B+">"+v[C]+"</td><td>"+x[C]+"</td></tr>"}}y+="</table>";if(Ext.isObject(p)&&p.destroy){A=p.getPosition();p.destroy();p=null}p=Ext.create("Ext.window.Window",{title:"Event",layout:"fit",resizable:false,bodyStyle:"background-color:#fff; padding:5px",html:y,autoShow:true,listeners:{show:function(E){if(A){E.setPosition(A)}else{r.util.gui.window.setPositionTopRight(E)}},destroy:function(){p=null}}})}}m=new OpenLayers.Control.newSelectFeature(l,u);r.olmap.addControl(m);m.activate()};GIS.core.OrganisationUnitLevelStore=function(i){return Ext.create("Ext.data.Store",{fields:["id","name","level"],proxy:{type:"jsonp",url:i.init.contextPath+i.conf.finals.url.path_api+"organisationUnitLevels.jsonp?viewClass=detailed&links=false&paging=false",reader:{type:"json",root:"organisationUnitLevels"}},autoLoad:true,cmp:[],isLoaded:false,loadFn:function(j){if(this.isLoaded){j.call()}else{this.load(j)}},getRecordByLevel:function(j){return this.getAt(this.findExact("level",j))},listeners:{load:function(){if(!this.isLoaded){this.isLoaded=true;i.util.gui.combo.setQueryMode(this.cmp,"local")}this.sort("level","ASC")}}})};GIS.core.StyleMap=function(l,j){var k={fillOpacity:1,strokeColor:"#fff",strokeWidth:1},i={fillOpacity:0.9,strokeColor:"#fff",strokeWidth:1,cursor:"pointer"};if(l==="boundary"){k.fillOpacity=0;k.strokeColor="#000";k.strokeWidth=1;i.fillColor="#000";i.fillOpacity=0.15;i.strokeColor="#000";i.strokeWidth=1}if(j){k.label="${label}";k.fontFamily="arial,sans-serif,ubuntu,consolas";k.fontSize=(j.fontSize||13)+"px";k.fontWeight=j.strong?"bold":"normal";k.fontStyle=j.italic?"italic":"normal";k.fontColor=j.color?(j.color.split("").shift()!=="#"?"#"+j.color:j.color):"#000000"}return new OpenLayers.StyleMap({"default":k,select:i})};GIS.core.VectorLayer=function(i,m,k,j){var l=new OpenLayers.Layer.Vector(k,{strategies:[new OpenLayers.Strategy.Refresh({force:true})],styleMap:GIS.core.StyleMap(m),visibility:false,displayInLayerSwitcher:false,layerType:i.conf.finals.layer.type_vector,layerOpacity:j?j.opacity||1:1,setLayerOpacity:function(n){if(n){this.layerOpacity=parseFloat(n)}this.setOpacity(this.layerOpacity)},hasLabels:false});l.id=m;return l};GIS.core.MeasureWindow=function(i){var k,j,l,n,m;m=new OpenLayers.StyleMap({"default":new OpenLayers.Style()});n=new OpenLayers.Control.Measure(OpenLayers.Handler.Path,{persist:true,immediate:true,handlerOption:{layerOptions:{styleMap:m}}});l=function(o){if(o.measure){j.setText(o.measure.toFixed(2)+" "+o.units)}};i.olmap.addControl(n);n.events.on({measurepartial:l,measure:l});n.geodesic=true;n.activate();j=Ext.create("Ext.form.Label",{style:"height: 20px",text:"0 km"});k=Ext.create("Ext.window.Window",{title:GIS.i18n.measure_distance,layout:"fit",cls:"gis-container-default gis-plugin",bodyStyle:"text-align: center",width:130,minWidth:130,resizable:false,items:j,listeners:{show:function(){var o=i.viewport.eastRegion.getPosition()[0]-this.getWidth()-3,p=i.viewport.centerRegion.getPosition()[1]+26;this.setPosition(o,p)},destroy:function(){n.deactivate();i.olmap.removeControl(n)}}});return k};GIS.core.MapLoader=function(j){var n,l,o,m,k=[],i;n=function(){Ext.data.JsonP.request({url:j.init.contextPath+j.conf.finals.url.path_api+"maps/"+j.map.id+".jsonp?viewClass=dimensional&links=false",success:function(v){if(Ext.isArray(v.mapViews)){for(var t=0,p;t<v.mapViews.length;t++){p=v.mapViews[t];if(p){if(Ext.isArray(p.columns)&&p.columns.length){for(var s=0,w;s<p.columns.length;s++){w=p.columns[s];if(Ext.isArray(w.items)&&w.items.length){for(var q=0,u;q<w.items.length;q++){u=w.items[q];u.id=u.id.replace(".","-")}}}}}}}j.map=v;l()},failure:function(){j.olmap.mask.hide();alert("Map id not recognized"+(j.el?" ("+j.el+")":""));return}})};l=function(){var q=j.map.mapViews,p;if(!(Ext.isArray(q)&&q.length)){j.olmap.mask.hide();alert(GIS.i18n.favorite_outdated_create_new);return}for(var r=0;r<q.length;r++){q[r]=j.api.layout.Layout(q[r])}q=Ext.Array.clean(q);if(!q.length){return}if(j.viewport&&j.viewport.favoriteWindow&&j.viewport.favoriteWindow.isVisible()){j.viewport.favoriteWindow.destroy()}j.olmap.closeAllLayers();for(var r=0,s;r<q.length;r++){s=q[r];p=j.layer[s.layer].core.getLoader();p.updateGui=!j.el;p.callBack=m;p.load(s)}};m=function(p){k.push(p);if(k.length===j.map.mapViews.length){o()}};o=function(){k=[];if(j.el){j.olmap.zoomToVisibleExtent()}else{if(j.map.longitude&&j.map.latitude&&j.map.zoom){j.olmap.setCenter(new OpenLayers.LonLat(j.map.longitude,j.map.latitude),j.map.zoom)}else{j.olmap.zoomToVisibleExtent()}}if(j.map.id&&j.viewport.shareButton){j.viewport.shareButton.enable()}if(GIS.isSessionStorage){j.util.layout.setSessionStorage("map",j.util.layout.getAnalytical())}j.olmap.mask.hide()};i={load:function(p){j.olmap.mask.show();if(j.map&&j.map.id){n()}else{if(p){j.map={mapViews:p}}l()}}};return i};GIS.core.LayerLoaderEvent=function(r,k){var j=k.map,l,n,m,i,q,o,p=r.conf.finals.dimension;n=function(s){m(s)};m=function(s){s=s||k.core.view;var w="?",v=[];w+="stage="+s.stage.id;w+="&startDate="+s.startDate;w+="&endDate="+s.endDate;if(Ext.isArray(s.organisationUnits)){for(var u=0;u<s.organisationUnits.length;u++){w+="&dimension=ou:"+s.organisationUnits[u].id}}for(var u=0,t;u<s.dataElements.length;u++){t=s.dataElements[u];w+="&dimension="+t.id;if(t.value){if(t.operator){w+=":"+t.operator}w+=":"+t.value}}Ext.data.JsonP.request({url:r.init.contextPath+"/api/analytics/events/query/"+s.program.id+".jsonp"+w,disableCaching:false,scope:this,success:function(y){var H=[],B=[],J=[],x,C,A=Ext.clone(y.metaData.names);for(var F=0;F<y.headers.length;F++){A[y.headers[F].name]=y.headers[F].column;if(y.headers[F].name==="longitude"){x=F}if(y.headers[F].name==="latitude"){C=F}}if(Ext.isArray(y.rows)&&y.rows.length){for(var F=0,I;F<y.rows.length;F++){I=y.rows[F];if(I[x]&&I[C]){J.push(I)}}}if(!J.length){alert("No coordinates found");j.mask.hide();return}A=Ext.clone(y.metaData.names);for(var F=0;F<y.headers.length;F++){A[y.headers[F].name]=y.headers[F].column}for(var F=0,I,E;F<J.length;F++){I=J[F];E={};for(var D=0;D<I.length;D++){E[y.headers[D].name]=I[D]}E[r.conf.finals.widget.value]=0;E.label=E.ouname;E.nameColumnMap=A;H.push(E)}for(var F=0,z,G;F<H.length;F++){z=H[F];G=r.util.map.getTransformedPointByXY(z.longitude,z.latitude);B.push(new OpenLayers.Feature.Vector(G,z))}k.removeFeatures(k.features);k.addFeatures(B);i(s)}})};i=function(s){s=s||k.core.view;var t={indicator:r.conf.finals.widget.value,method:2,numClasses:5,colors:k.core.getColors("000000","222222"),minSize:5,maxSize:5};k.core.view=s;k.core.applyClassification(t);q(s)};q=function(s){if(k.item){k.item.setValue(true,s.opacity)}else{k.setLayerOpacity(s.opacity)}if(o.updateGui&&Ext.isObject(k.widget)){k.widget.setGui(s)}if(o.zoomToVisibleExtent){j.zoomToVisibleExtent()}if(o.hideMask){j.mask.hide()}if(o.callBack){o.callBack(k)}else{r.map=null}};o={compare:false,updateGui:false,zoomToVisibleExtent:false,hideMask:false,callBack:null,load:function(s){r.olmap.mask.show();n(s)},loadData:m,loadLegend:i};return o};GIS.core.LayerLoaderFacility=function(r,l){var j=l.map,m,o,n,i,k,q,p;m=function(u,x){var z=l.core.view,y,t,s,v;p.zoomToVisibleExtent=true;if(!z){if(x){o(u)}return r.conf.finals.widget.loadtype_organisationunit}y=[];t=u.rows[0];s=[];v=z.rows[0];if(t.items.length===v.items.length){for(var w=0;w<t.items.length;w++){y.push(t.items[w].id)}for(var w=0;w<v.items.length;w++){s.push(v.items[w].id)}if(Ext.Array.difference(y,s).length!==0){if(x){o(u)}return r.conf.finals.widget.loadtype_organisationunit}}else{if(x){o(u)}return r.conf.finals.widget.loadtype_organisationunit}p.zoomToVisibleExtent=false;if(u.organisationUnitGroupSet.id!==z.organisationUnitGroupSet.id){if(x){o(u)}return r.conf.finals.widget.loadtype_organisationunit}if(x){i(u);return r.conf.finals.widget.loadtype_legend}};o=function(s){var t=s.rows[0].items,v="";for(var u=0;u<t.length;u++){v+="ids="+t[u].id;v+=u!==t.length-1?"&":""}Ext.data.JsonP.request({url:r.init.contextPath+r.conf.finals.url.path_module+"getGeoJsonFacilities.action?"+v,scope:this,disableCaching:false,success:function(y){var w=l.core.decode(y),z=new OpenLayers.Format.GeoJSON(),x=r.util.map.getTransformedFeatureArray(z.read(w));if(!Ext.isArray(x)){j.mask.hide();alert(GIS.i18n.invalid_coordinates);return}if(!x.length){j.mask.hide();alert(GIS.i18n.no_valid_coordinates_found);return}l.core.featureStore.loadFeatures(x.slice(0));n(s,x)},failure:function(w){j.mask.hide();alert(GIS.i18n.coordinates_could_not_be_loaded)}})};n=function(s,u){s=s||l.core.view;u=u||l.core.featureStore.features;for(var t=0;t<u.length;t++){u[t].attributes.label=u[t].attributes.name}l.removeFeatures(l.features);l.addFeatures(u);i(s)};i=function(s){s=s||l.core.view;var t=r.store.groupsByGroupSet;t.proxy.url=r.init.contextPath+r.conf.finals.url.path_module+"getOrganisationUnitGroupsByGroupSet.action?id="+s.organisationUnitGroupSet.id;t.load({scope:this,callback:function(){var u={indicator:s.organisationUnitGroupSet.id};l.core.view=s;l.core.applyClassification(u);k(s);q(s)}})};k=function(t){var s=t.areaRadius;if(l.circleLayer){l.circleLayer.deactivateControls();l.circleLayer=null}if(Ext.isDefined(s)&&s){l.circleLayer=GIS.app.CircleLayer(l.features,s);nissa=l.circleLayer}};q=function(s){r.viewport.eastRegion.doLayout();l.legendPanel.expand();if(l.item){l.item.setValue(true,s.opacity)}else{l.setLayerOpacity(s.opacity)}if(p.updateGui&&Ext.isObject(l.widget)){l.widget.setGui(s)}if(p.zoomToVisibleExtent){j.zoomToVisibleExtent()}if(p.hideMask){j.mask.hide()}if(p.callBack){p.callBack(l)}else{r.map=null}};p={compare:false,updateGui:false,zoomToVisibleExtent:false,hideMask:false,callBack:null,load:function(s){r.olmap.mask.show();if(this.compare){m(s,true)}else{o(s)}},loadData:n,loadLegend:i};return p};GIS.core.LayerLoaderBoundary=function(q,k){var j=k.map,l,n,m,i,p,o;l=function(t,w){var y=k.core.view,x,s,r,u;if(!y){if(w){n(t)}return q.conf.finals.widget.loadtype_organisationunit}x=[];s=t.rows[0];r=[];u=y.rows[0];if(s.items.length===u.items.length){for(var v=0;v<s.items.length;v++){x.push(s.items[v].id)}for(var v=0;v<u.items.length;v++){r.push(u.items[v].id)}if(Ext.Array.difference(x,r).length!==0){if(w){n(t)}return q.conf.finals.widget.loadtype_organisationunit}}else{if(w){n(t)}return q.conf.finals.widget.loadtype_organisationunit}q.olmap.mask.hide()};n=function(r){var s=r.rows[0].items,u="";for(var t=0;t<s.length;t++){u+="ids="+s[t].id;u+=t!==s.length-1?"&":""}Ext.data.JsonP.request({url:q.init.contextPath+q.conf.finals.url.path_module+"getGeoJson.action?"+u,scope:this,disableCaching:false,success:function(x){var v=q.util.geojson.decode(x),y=new OpenLayers.Format.GeoJSON(),w=q.util.map.getTransformedFeatureArray(y.read(v));if(!Ext.isArray(w)){j.mask.hide();alert(GIS.i18n.invalid_coordinates);return}if(!w.length){j.mask.hide();alert(GIS.i18n.no_valid_coordinates_found);return}k.core.featureStore.loadFeatures(w.slice(0));m(r,w)},failure:function(v){j.mask.hide();alert(GIS.i18n.coordinates_could_not_be_loaded)}})};m=function(r,t){r=r||k.core.view;t=t||k.core.featureStore.features;for(var s=0;s<t.length;s++){t[s].attributes.label=t[s].attributes.name;t[s].attributes.value=0}k.removeFeatures(k.features);k.addFeatures(t);i(r)};i=function(r){r=r||k.core.view;var s={indicator:q.conf.finals.widget.value,method:2,numClasses:5,colors:k.core.getColors("000000","000000"),minSize:6,maxSize:6};if(r.labels){if(Ext.isObject(r.labels)){k.styleMap=GIS.core.StyleMap(k.id,r.labels)}else{k.styleMap=GIS.core.StyleMap(k.id,{fontSize:12,strong:false,italic:false,color:"#000"})}}k.core.view=r;k.core.applyClassification(s);p(r)};p=function(r){if(k.item){k.item.setValue(true,r.opacity)}else{k.setLayerOpacity(r.opacity)}if(o.updateGui&&Ext.isObject(k.widget)){k.widget.setGui(r)}if(o.zoomToVisibleExtent){j.zoomToVisibleExtent()}if(o.hideMask){j.mask.hide()}if(o.callBack){o.callBack(k)}else{q.map=null}};o={compare:false,updateGui:false,zoomToVisibleExtent:false,hideMask:false,callBack:null,load:function(r){q.olmap.mask.show();if(this.compare){l(r,true)}else{n(r)}},loadData:m,loadLegend:i};return o};GIS.core.LayerLoaderThematic=function(r,k){var j=k.map,l,n,m,i,q,o,p=r.conf.finals.dimension;l=function(u,x){var z=k.core.view,y,t,s,v;o.zoomToVisibleExtent=true;if(!z){if(x){n(u)}return r.conf.finals.widget.loadtype_organisationunit}y=[];t=u.rows[0];s=[];v=z.rows[0];if(t.items.length===v.items.length){for(var w=0;w<t.items.length;w++){y.push(t.items[w].id)}for(var w=0;w<v.items.length;w++){s.push(v.items[w].id)}if(Ext.Array.difference(y,s).length!==0){if(x){n(u)}return r.conf.finals.widget.loadtype_organisationunit}}else{if(x){n(u)}return r.conf.finals.widget.loadtype_organisationunit}o.zoomToVisibleExtent=false;y=[];t=u.columns[0];s=[];v=z.columns[0];if(t.items.length===v.items.length){for(var w=0;w<t.items.length;w++){y.push(t.items[w].id)}for(var w=0;w<v.items.length;w++){s.push(v.items[w].id)}if(Ext.Array.difference(y,s).length!==0){if(x){m(u)}return r.conf.finals.widget.loadtype_organisationunit}}else{if(x){m(u)}return r.conf.finals.widget.loadtype_organisationunit}y=[];t=u.filters[0];s=[];v=z.filters[0];if(t.items.length===v.items.length){for(var w=0;w<t.items.length;w++){y.push(t.items[w].id)}for(var w=0;w<v.items.length;w++){s.push(v.items[w].id)}if(Ext.Array.difference(y,s).length!==0){if(x){m(u)}return r.conf.finals.widget.loadtype_organisationunit}}else{if(x){m(u)}return r.conf.finals.widget.loadtype_organisationunit}if(x){o.zoomToVisibleExtent=false;i(u);return r.conf.finals.widget.loadtype_legend}};n=function(s){var t=s.rows[0].items,v="";for(var u=0;u<t.length;u++){v+="ids="+t[u].id;v+=u!==t.length-1?"&":""}Ext.data.JsonP.request({url:r.init.contextPath+r.conf.finals.url.path_module+"getGeoJson.action?"+v,scope:this,disableCaching:false,success:function(y){var w=r.util.geojson.decode(y),z=new OpenLayers.Format.GeoJSON(),x=r.util.map.getTransformedFeatureArray(z.read(w));if(!Ext.isArray(x)){j.mask.hide();alert(GIS.i18n.invalid_coordinates);return}if(!x.length){j.mask.hide();alert(GIS.i18n.no_valid_coordinates_found);return}k.core.featureStore.loadFeatures(x.slice(0));m(s,x)},failure:function(w){j.mask.hide();alert(GIS.i18n.coordinates_could_not_be_loaded)}})};m=function(z,u){var B;z=z||k.core.view;u=u||k.core.featureStore.features;var A=r.conf.finals.dimension,v="?",w=z.columns[0].items,s=z.columns[0].dimension===A.operand.objectName,t=z.filters[0].items,y=z.rows[0].items;v+="dimension=ou:";for(var x=0;x<y.length;x++){v+=y[x].id;v+=x<y.length-1?";":""}v+="&dimension=dx:";for(var x=0;x<w.length;x++){v+=s?w[x].id.split("-")[0]:w[x].id;v+=x<w.length-1?";":""}v+=s?"&dimension=co":"";v+="&filter=pe:";for(var x=0;x<t.length;x++){v+=t[x].id;v+=x<t.length-1?";":""}B=function(O){var H=r.api.response.Response(O),M={},E={},J,G,L,F=[],C,K=[];if(!H){j.mask.hide();return}for(var I=0;I<H.headers.length;I++){if(H.headers[I].name===A.organisationUnit.dimensionName){J=I}else{if(H.headers[I].name===A.value.dimensionName){L=I}}}for(var I=0,D;I<u.length;I++){var D=u[I].attributes.id;M[D]=true}for(var I=0;I<H.rows.length;I++){var D=H.rows[I][J],N=parseFloat(H.rows[I][L]);E[D]=N}for(var I=0;I<u.length;I++){var P=u[I],D=P.attributes.id;if(M.hasOwnProperty(D)&&E.hasOwnProperty(D)){P.attributes.value=E[D];P.attributes.label=P.attributes.name+" ("+P.attributes.value+")";F.push(P)}}k.removeFeatures(k.features);k.addFeatures(F);r.response=H;i(z)};if(Ext.isObject(GIS.app)){Ext.Ajax.request({url:r.init.contextPath+"/api/analytics.json"+v,disableCaching:false,failure:function(C){alert(C.responseText)},success:function(C){B(Ext.decode(C.responseText))}})}else{if(Ext.isObject(GIS.plugin)){Ext.data.JsonP.request({url:r.init.contextPath+"/api/analytics.jsonp"+v,disableCaching:false,scope:this,success:function(C){B(C)}})}}};i=function(u){var w,y,v;u=u||k.core.view;y=function(C){var A=Ext.Array.clean([].concat(u.columns||[],u.rows||[],u.filters||[])),B=C.metaData,H=B[p.period.objectName];for(var F=0,D;F<A.length;F++){D=A[F];for(var E=0,G;E<D.items.length;E++){G=D.items[E];if(G.id.indexOf("-")!==-1){var z=G.id.split("-");G.name=B.names[z[0]]+" "+B.names[z[1]]}else{G.name=B.names[G.id]}}}u.filters[0].items[0].name=B.names[H[H.length-1]]};v=function(){y(r.response);var z={indicator:r.conf.finals.widget.value,method:u.legendSet?mapfish.GeoStat.Distribution.CLASSIFY_WITH_BOUNDS:u.method,numClasses:u.classes,bounds:w,colors:k.core.getColors(u.colorLow,u.colorHigh),minSize:u.radiusLow,maxSize:u.radiusHigh};k.core.view=u;k.core.colorInterpolation=t;k.core.applyClassification(z);q(u)};if(u.labels){if(Ext.isObject(u.labels)){k.styleMap=GIS.core.StyleMap(k.id,u.labels)}else{k.styleMap=GIS.core.StyleMap(k.id,{fontSize:12,strong:false,italic:false,color:"#000"})}}if(u.legendSet){var w=[],t=[],x=[],s=[];Ext.Ajax.request({url:r.init.contextPath+r.conf.finals.url.path_api+"mapLegendSets/"+u.legendSet.id+".json?links=false&paging=false",scope:this,success:function(A){s=Ext.decode(A.responseText).mapLegends;Ext.Array.sort(s,function(C,B){return C.startValue-B.startValue});for(var z=0;z<s.length;z++){if(w[w.length-1]!==s[z].startValue){if(w.length!==0){t.push(new mapfish.ColorRgb(240,240,240));x.push("")}w.push(s[z].startValue)}t.push(new mapfish.ColorRgb());t[t.length-1].setFromHex(s[z].color);x.push(s[z].name);w.push(s[z].endValue)}u.legendSet.names=x;u.legendSet.bounds=w;u.legendSet.colors=t;v()}})}else{v()}};q=function(s){r.viewport.eastRegion.doLayout();k.legendPanel.expand();k.setLayerOpacity(s.opacity);if(k.item){k.item.setValue(true)}if(k.filterWindow&&k.filterWindow.isVisible()){k.filterWindow.filter()}if(o.updateGui&&Ext.isObject(k.widget)){k.widget.setGui(s)}if(o.zoomToVisibleExtent){j.zoomToVisibleExtent()}if(o.hideMask){j.mask.hide()}if(o.callBack){o.callBack(k)}else{r.map=null;if(r.viewport.shareButton){}}if(GIS.isSessionStorage){r.util.layout.setSessionStorage("map",r.util.layout.getAnalytical())}};o={compare:false,updateGui:false,zoomToVisibleExtent:false,hideMask:false,callBack:null,load:function(s){r.olmap.mask.show();if(this.compare){l(s,true)}else{n(s)}},loadData:m,loadLegend:i};return o};GIS.core.getInstance=function(o){var l={},j={},m={},k={},n=[],i={};(function(){l.finals={url:{path_api:"/api/",path_module:"/dhis-web-mapping/",path_commons:"/dhis-web-commons-ajax-json/",organisationunitchildren_get:"getOrganisationUnitChildren.action",organisationunitgroup_getall:"organisationUnitGroups.json?paging=false&links=false",dataset_get:"dataSets.json?paging=false&links=false"},layer:{type_base:"base",type_vector:"vector",category_thematic:"thematic"},dimension:{data:{id:"data",value:"data",param:"dx",dimensionName:"dx",objectName:"dx"},category:{name:GIS.i18n.categories,dimensionName:"co",objectName:"co"},indicator:{id:"indicator",value:"indicators",param:"in",dimensionName:"dx",objectName:"in"},dataElement:{id:"dataElement",value:"dataElement",param:"de",dimensionName:"dx",objectName:"de"},operand:{id:"operand",value:"operand",param:"dc",dimensionName:"dx",objectName:"dc"},dataSet:{value:"dataSets",dimensionName:"dx",objectName:"ds"},period:{id:"period",value:"period",param:"pe",dimensionName:"pe",objectName:"pe"},organisationUnit:{id:"organisationUnit",value:"organisationUnit",param:"ou",dimensionName:"ou",objectName:"ou"},value:{id:"value",value:"value",param:"value",dimensionName:"value",objectName:"value"}},widget:{value:"value",legendtype_automatic:"automatic",legendtype_predefined:"predefined",symbolizer_color:"color",symbolizer_image:"image",loadtype_organisationunit:"organisationUnit",loadtype_data:"data",loadtype_legend:"legend"},openLayers:{point_classname:"OpenLayers.Geometry.Point"},mapfish:{classify_with_bounds:1,classify_by_equal_intervals:2,classify_by_quantils:3},root:{id:"root"}};l.layout={widget:{item_width:288,itemlabel_width:95,window_width:310},tool:{item_width:228,itemlabel_width:95,window_width:250},grid:{row_height:27}};l.period={periodTypes:[{id:"relativePeriods",name:GIS.i18n.relative},{id:"Daily",name:GIS.i18n.daily},{id:"Weekly",name:GIS.i18n.weekly},{id:"Monthly",name:GIS.i18n.monthly},{id:"BiMonthly",name:GIS.i18n.bimonthly},{id:"Quarterly",name:GIS.i18n.quarterly},{id:"SixMonthly",name:GIS.i18n.sixmonthly},{id:"SixMonthlyApril",name:GIS.i18n.sixmonthly_april},{id:"Yearly",name:GIS.i18n.yearly},{id:"FinancialOct",name:GIS.i18n.financial_oct},{id:"FinancialJuly",name:GIS.i18n.financial_july},{id:"FinancialApril",name:GIS.i18n.financial_april}],relativePeriods:[{id:"LAST_WEEK",name:GIS.i18n.last_week},{id:"LAST_MONTH",name:GIS.i18n.last_month},{id:"LAST_BIMONTH",name:GIS.i18n.last_bimonth},{id:"LAST_QUARTER",name:GIS.i18n.last_quarter},{id:"LAST_SIX_MONTH",name:GIS.i18n.last_sixmonth},{id:"LAST_FINANCIAL_YEAR",name:GIS.i18n.last_financial_year},{id:"THIS_YEAR",name:GIS.i18n.this_year},{id:"LAST_YEAR",name:GIS.i18n.last_year}],relativePeriodsMap:{LAST_WEEK:{id:"LAST_WEEK",name:GIS.i18n.last_week},LAST_MONTH:{id:"LAST_MONTH",name:GIS.i18n.last_month},LAST_BIMONTH:{id:"LAST_BIMONTH",name:GIS.i18n.last_bimonth},LAST_QUARTER:{id:"LAST_QUARTER",name:GIS.i18n.last_quarter},LAST_SIX_MONTH:{id:"LAST_SIX_MONTH",name:GIS.i18n.last_sixmonth},LAST_FINANCIAL_YEAR:{id:"LAST_FINANCIAL_YEAR",name:GIS.i18n.last_financial_year},THIS_YEAR:{id:"THIS_YEAR",name:GIS.i18n.this_year},LAST_YEAR:{id:"LAST_YEAR",name:GIS.i18n.last_year}},integratedRelativePeriodsMap:{LAST_WEEK:"LAST_WEEK",LAST_4_WEEKS:"LAST_WEEK",LAST_12_WEEKS:"LAST_WEEK",LAST_MONTH:"LAST_MONTH",LAST_3_MONTHS:"LAST_MONTH",LAST_12_MONTHS:"LAST_MONTH",LAST_BIMONTH:"LAST_BIMONTH",LAST_6_BIMONTHS:"LAST_BIMONTH",LAST_QUARTER:"LAST_QUARTER",LAST_4_QUARTERS:"LAST_QUARTER",LAST_SIX_MONTH:"LAST_SIX_MONTH",LAST_2_SIXMONTHS:"LAST_SIX_MONTH",LAST_FINANCIAL_YEAR:"LAST_FINANCIAL_YEAR",LAST_5_FINANCIAL_YEARS:"LAST_FINANCIAL_YEAR",THIS_YEAR:"THIS_YEAR",LAST_YEAR:"LAST_YEAR",LAST_5_YEARS:"LAST_YEAR"}}}());(function(){j.map={};j.map.getVisibleVectorLayers=function(){var r=[];for(var q=0,p;q<i.olmap.layers.length;q++){p=i.olmap.layers[q];if(p.layerType===l.finals.layer.type_vector&&p.visibility&&p.features.length){r.push(p)}}return r};j.map.getExtendedBounds=function(r){var q=null;if(r.length){q=r[0].getDataExtent();if(r.length>1){for(var p=1;p<r.length;p++){q.extend(r[p].getDataExtent())}}}return q};j.map.zoomToVisibleExtent=function(q){var p=j.map.getExtendedBounds(j.map.getVisibleVectorLayers(q));if(p){q.zoomToExtent(p)}};j.map.getTransformedFeatureArray=function(s){var p=new OpenLayers.Projection("EPSG:4326"),q=new OpenLayers.Projection("EPSG:900913");for(var r=0;r<s.length;r++){s[r].geometry.transform(p,q)}return s};j.geojson={};j.geojson.decode=function(r){var p={};p.type="FeatureCollection";p.crs={type:"EPSG",properties:{code:"4326"}};p.features=[];for(var q=0;q<r.geojson.length;q++){p.features.push({geometry:{type:parseInt(r.geojson[q].ty)===1?"MultiPolygon":"Point",coordinates:r.geojson[q].co},properties:{id:r.geojson[q].uid,internalId:r.geojson[q].iid,name:r.geojson[q].na,hasCoordinatesDown:r.geojson[q].hcd,hasCoordinatesUp:r.geojson[q].hcu,level:r.geojson[q].le,grandParentParentGraph:r.geojson[q].gppg,grandParentId:r.geojson[q].gpuid,parentGraph:r.geojson[q].parentGraph,parentId:r.geojson[q].pi,parentName:r.geojson[q].pn}})}return p};j.gui={};j.gui.combo={};j.gui.combo.setQueryMode=function(p,r){for(var q=0;q<p.length;q++){p[q].queryMode=r}};j.object={};j.object.sortObjectsByString=function(q,p){p=p||"name";q.sort(function(s,r){var u=s[p].toLowerCase(),t=r[p].toLowerCase();if(u<t){return -1}if(u>t){return 1}return 0});return q};j.object.getLength=function(p){var r=0;for(var q in p){if(p.hasOwnProperty(q)){r++}}return r}}());i.init=o;i.conf=l;i.util=j;(function(){var p=i.conf.finals.dimension;m.layout={};m.response={};m.layout.Record=function(r){var q={};return function(){if(!Ext.isObject(r)){console.log("Record config is not an object: "+r);return}if(!Ext.isString(r.id)){alert("Record id is not text: "+r);return}q.id=r.id.replace(".","-");if(Ext.isString(r.name)){q.name=r.name}return Ext.clone(q)}()};m.layout.Dimension=function(q){var r={};return function(){if(!Ext.isObject(q)){return}if(!Ext.isString(q.dimension)){console.log("Dimension name is not text: "+q);return}if(q.dimension!==l.finals.dimension.category.objectName){var s=[];if(!Ext.isArray(q.items)){console.log("Dimension items is not an array: "+q);return}for(var t=0;t<q.items.length;t++){record=m.layout.Record(q.items[t]);if(record){s.push(record)}}q.items=s;if(!q.items.length){console.log("Dimension has no valid items: "+q);return}}r.dimension=q.dimension;r.items=q.items;return Ext.clone(r)}()};m.layout.Layout=function(r){var r=Ext.clone(r),s={},q,t;q=function(x){var v=[];if(!(x&&Ext.isArray(x)&&x.length)){return}for(var u=0,w;u<x.length;u++){w=m.layout.Dimension(x[u]);if(w){v.push(w)}}x=v;return x.length?x:null};t=function(w){var y=Ext.Array.clean([].concat(w.columns||[],w.rows||[],w.filters||[])),A=l.period.integratedRelativePeriodsMap,v,B,u;for(var x=0,z;x<y.length;x++){z=y[x];if(z.dimension===p.indicator.objectName||z.dimension===p.dataElement.objectName||z.dimension===p.operand.objectName||z.dimension===p.dataSet.objectName){v=z}else{if(z.dimension===p.period.objectName){B=z}else{if(z.dimension===p.organisationUnit.objectName){u=z}}}}if(!u){alert("No organisation units specified");return}if(v){v.items=[v.items[0]]}if(B){B.items=[B.items[0]];B.items[0].id=A[B.items[0].id]?A[B.items[0].id]:B.items[0].id}w.columns=[v];w.rows=[u];w.filters=[B];return w};return function(){var A=[],z=[],C=l.finals.dimension,v=false,u=false,D=false;r=t(r);if(!r){return}r.columns=q(r.columns);r.rows=q(r.rows);r.filters=q(r.filters);if(!r.rows){console.log("Organisation unit dimension is invalid");return}for(var x=0,y,B=Ext.Array.clean([].concat(r.columns,r.rows,r.filters));x<B.length;x++){y=B[x];if(y){if(Ext.isString(y.dimension)){z.push(y.dimension)}if(y.dimension===C.organisationUnit.objectName&&Ext.isArray(y.items)){for(var w=0;w<y.items.length;w++){if(y.items[w].id==="USER_ORGUNIT"){v=true}else{if(y.items[w].id==="USER_ORGUNIT_CHILDREN"){u=true}else{if(y.items[w].id==="USER_ORGUNIT_GRANDCHILDREN"){D=true}}}}}}}s.columns=r.columns;s.rows=r.rows;s.filters=r.filters;s.layer=Ext.isString(r.layer)&&!Ext.isEmpty(r.layer)?r.layer:"thematic1";s.classes=Ext.isNumber(r.classes)&&!Ext.isEmpty(r.classes)?r.classes:5;s.method=Ext.isNumber(r.method)&&!Ext.isEmpty(r.method)?r.method:2;s.colorLow=Ext.isString(r.colorLow)&&!Ext.isEmpty(r.colorLow)?r.colorLow:"ff0000";s.colorHigh=Ext.isString(r.colorHigh)&&!Ext.isEmpty(r.colorHigh)?r.colorHigh:"00ff00";s.radiusLow=Ext.isNumber(r.radiusLow)&&!Ext.isEmpty(r.radiusLow)?r.radiusLow:5;s.radiusHigh=Ext.isNumber(r.radiusHigh)&&!Ext.isEmpty(r.radiusHigh)?r.radiusHigh:15;s.opacity=Ext.isNumber(r.opacity)&&!Ext.isEmpty(r.opacity)?r.opacity:0.8;s.userOrganisationUnit=v;s.userOrganisationUnitChildren=u;s.userOrganisationUnitGrandChildren=D;s.parentGraphMap=Ext.isObject(r.parentGraphMap)?r.parentGraphMap:null;s.legendSet=r.legendSet;s.labels=r.labels;s.organisationUnitGroupSet=r.organisationUnitGroupSet;s.areaRadius=r.areaRadius;return s}()};m.response.Header=function(q){var r={};return function(){if(!Ext.isObject(q)){console.log("Header is not an object: "+q);return}if(!Ext.isString(q.name)){console.log("Header name is not text: "+q);return}if(!Ext.isBoolean(q.meta)){console.log("Header meta is not boolean: "+q);return}r.name=q.name;r.meta=q.meta;return Ext.clone(r)}()};m.response.Response=function(r){var q={};return function(){var t=[];if(!(r&&Ext.isObject(r))){alert("Data response invalid");return false}if(!(r.headers&&Ext.isArray(r.headers))){alert("Data response invalid");return false}for(var s=0,u;s<r.headers.length;s++){u=m.response.Header(r.headers[s]);if(u){t.push(u)}}r.headers=t;if(!r.headers.length){alert("No valid response headers");return}if(!(Ext.isArray(r.rows)&&r.rows.length>0)){alert("No values found");return false}if(r.headers.length!==r.rows[0].length){alert("Data invalid");return false}q.headers=r.headers;q.metaData=r.metaData;q.width=r.width;q.height=r.height;q.rows=r.rows;return q}()}}());(function(){k.organisationUnitLevels=GIS.core.OrganisationUnitLevelStore(i)}());i.api=m;i.store=k;i.olmap=GIS.core.getOLMap(i);i.layer=GIS.core.getLayers(i);i.thematicLayers=[i.layer.thematic1,i.layer.thematic2,i.layer.thematic3,i.layer.thematic4];if(window.google){n.push(i.layer.googleStreets,i.layer.googleHybrid)}n.push(i.layer.openStreetMap,i.layer.thematic4,i.layer.thematic3,i.layer.thematic2,i.layer.thematic1,i.layer.boundary,i.layer.facility,i.layer.event);i.olmap.addLayers(n);GIS.core.instances.push(i);e=i.layer.event;return i};(function(){window.mapfish={_scriptName:"MapFish.js",_getScriptLocation:function(){if(window.gMfLocation){return window.gMfLocation}var t="";var u=mapfish._scriptName;var q=document.getElementsByTagName("script");for(var s=0;s<q.length;s++){var v=q[s].getAttribute("src");if(v){var r=v.lastIndexOf(u);if((r>-1)&&(r+u.length==v.length)){t=v.slice(0,-u.length);break}}}return t}};var o=new Array("core/Color.js","core/GeoStat.js","core/GeoStat/Boundary.js","core/GeoStat/Thematic1.js","core/GeoStat/Thematic2.js","core/GeoStat/Facility.js","core/GeoStat/Symbol.js","core/Util.js");var p="";var n=mapfish._getScriptLocation();for(var j=0;j<o.length;j++){if(/MSIE/.test(navigator.userAgent)||/Safari/.test(navigator.userAgent)){var m="<script src='"+n+o[j]+"'><\/script>";p+=m}else{var l=document.createElement("script");l.src=n+o[j];var k=document.getElementsByTagName("head").length?document.getElementsByTagName("head")[0]:document.body;k.appendChild(l)}}if(p){}mapfish.Color=OpenLayers.Class({getColorRgb:function(){}});mapfish.ColorRgb=OpenLayers.Class(mapfish.Color,{redLevel:null,greenLevel:null,blueLevel:null,initialize:function(r,q,i){this.redLevel=r;this.greenLevel=q;this.blueLevel=i},equals:function(i){return i.redLevel==this.redLevel&&i.greenLevel==this.greenLevel&&i.blueLevel==this.blueLevel},getColorRgb:function(){return this},getRgbArray:function(){return[this.redLevel,this.greenLevel,this.blueLevel]},hex2rgbArray:function(q){if(q.charAt(0)=="#"){q=q.substr(1)}var r=[parseInt(q.substring(0,2),16),parseInt(q.substring(2,4),16),parseInt(q.substring(4,6),16)];for(var s=0;s<r.length;s++){if(r[s]<0||r[s]>255){OpenLayers.Console.error("Invalid rgb hex color string: rgbHexString")}}return r},setFromHex:function(i){var q=this.hex2rgbArray(i);this.redLevel=q[0];this.greenLevel=q[1];this.blueLevel=q[2]},setFromRgb:function(q){var i=dojo.colorFromString(q);this.redLevel=i.r;this.greenLevel=i.g;this.blueLevel=i.b},toHexString:function(){var s=this.toHex(this.redLevel);var q=this.toHex(this.greenLevel);var i=this.toHex(this.blueLevel);return"#"+s+q+i},toHex:function(u){var r="0123456789ABCDEF";if(u<0||u>255){var t="Invalid decimal value for color level";OpenLayers.Console.error(t)}var s=Math.floor(u/16);var q=u%16;return r.charAt(s)+r.charAt(q)},CLASS_NAME:"mapfish.ColorRgb"});mapfish.ColorRgb.getColorsArrayByRgbInterpolation=function(y,t,v){var z=[];var r=y.getColorRgb();var q=t.getColorRgb();var x=r.getRgbArray();var w=q.getRgbArray();if(v==1){return[r]}for(var u=0;u<v;u++){var s=[];s[0]=x[0]+u*(w[0]-x[0])/(v-1);s[1]=x[1]+u*(w[1]-x[1])/(v-1);s[2]=x[2]+u*(w[2]-x[2])/(v-1);z[u]=new mapfish.ColorRgb(parseInt(s[0]),parseInt(s[1]),parseInt(s[2]))}return z};mapfish.Util={};mapfish.Util.sum=function(s){for(var q=0,r=0;q<s.length;r+=s[q++]){}return r};mapfish.Util.max=function(i){return Math.max.apply({},i)};mapfish.Util.min=function(i){return Math.min.apply({},i)};mapfish.Util.getIconUrl=function(q,i){if(!i.layer){OpenLayers.Console.warn("Missing required layer option in mapfish.Util.getIconUrl");return""}if(!i.rule){i.rule=i.layer}if(q.indexOf("?")<0){q+="?"}else{if(q.lastIndexOf("&")!=(q.length-1)){if(q.indexOf("?")!=(q.length-1)){q+="&"}}}var i=OpenLayers.Util.extend({layer:"",rule:"",service:"WMS",version:"1.1.1",request:"GetLegendGraphic",format:"image/png",width:16,height:16},i);i=OpenLayers.Util.upperCaseObject(i);return q+OpenLayers.Util.getParameterString(i)};mapfish.Util.arrayEqual=function(r,q){if(r==null||q==null){return false}if(typeof(r)!="object"||typeof(q)!="object"){return false}if(r.length!=q.length){return false}for(var s=0;s<r.length;s++){if(typeof(r[s])!=typeof(q[s])){return false}if(r[s]!=q[s]){return false}}return true};mapfish.Util.isIE7=function(){var i=navigator.userAgent.toLowerCase();return i.indexOf("msie 7")>-1};mapfish.Util.relativeToAbsoluteURL=function(q){if(/^\w+:/.test(q)||!q){return q}var i=location.protocol+"//"+location.host;if(q.indexOf("/")==0){return i+q}var r=location.pathname.replace(/\/[^\/]*$/,"");return i+r+"/"+q};mapfish.Util.fixArray=function(i){if(i==""||i==null){return[]}else{if(i instanceof Array){return i}else{return i.split(",")}}};mapfish.GeoStat=OpenLayers.Class({layer:null,format:null,url:null,requestSuccess:function(i){},requestFailure:function(i){},indicator:null,defaultSymbolizer:{},legendDiv:null,initialize:function(r,i){this.map=r;this.addOptions(i);if(!this.layer){var q=new OpenLayers.Layer.Vector("geostat",{displayInLayerSwitcher:false,visibility:false});r.addLayer(q);this.layer=q}this.setUrl(this.url);this.legendDiv=Ext.get(i.legendDiv)},setUrl:function(i){this.url=i;if(this.url){OpenLayers.Request.GET({url:this.url,scope:this,success:this.requestSuccess,failure:this.requestFailure})}},getColors:function(i,r){var s=new mapfish.ColorRgb(),q=new mapfish.ColorRgb();s.setFromHex(i);q.setFromHex(r);return[s,q]},addOptions:function(i){if(i){if(!this.options){this.options={}}OpenLayers.Util.extend(this.options,i);OpenLayers.Util.extend(this,i)}},extendStyle:function(s,r,i){var q=this.layer.styleMap.styles["default"];if(s){q.rules=s}if(r){q.setDefaultStyle(OpenLayers.Util.applyDefaults(r,q.defaultStyle))}if(i){if(!q.context){q.context={}}OpenLayers.Util.extend(q.context,i)}},applyClassification:function(i){this.layer.renderer.clear();this.layer.redraw();this.updateLegend();this.layer.setVisibility(true)},showDetails:function(i){},hideDetails:function(i){},CLASS_NAME:"mapfish.GeoStat"});mapfish.GeoStat.Distribution=OpenLayers.Class({labelGenerator:function(q,s,t){var i=parseFloat(q.lowerBound).toFixed(1),r=parseFloat(q.upperBound).toFixed(1);return i+" - "+r+"&nbsp;&nbsp;("+q.nbVal+")"},values:null,nbVal:null,minVal:null,maxVal:null,initialize:function(i,q){OpenLayers.Util.extend(this,q);this.values=i;this.nbVal=i.length;this.minVal=this.nbVal?mapfish.Util.min(this.values):0;this.maxVal=this.nbVal?mapfish.Util.max(this.values):0},classifyWithBounds:function(q){var z=[];var w=[];var y=[];for(var v=0;v<this.values.length;v++){y.push(this.values[v])}y.sort(function(A,i){return A-i});var x=q.length-1;for(var u=0;u<x;u++){w[u]=0}for(var t=0;t<x-1;t){if(y[0]<q[t+1]){w[t]=w[t]+1;y.shift()}else{t++}}w[x-1]=this.nbVal-mapfish.Util.sum(w);for(var s=0;s<x;s++){z[s]=new mapfish.GeoStat.Bin(w[s],q[s],q[s+1],s==(x-1));var r=this.labelGenerator||this.defaultLabelGenerator;z[s].label=r(z[s],s,x)}return new mapfish.GeoStat.Classification(z)},classifyByEqIntervals:function(s){var r=[];for(var q=0;q<=s;q++){r[q]=this.minVal+q*(this.maxVal-this.minVal)/s}return this.classifyWithBounds(r)},classifyByQuantils:function(u){var i=this.values;i.sort(function(w,v){return w-v});var t=Math.round(this.values.length/u);var s=[];var r=(t===0)?0:t;if(i.length>0){s[0]=i[0];for(j=1;j<u;j++){s[j]=i[r];r+=t}s.push(i[i.length-1])}for(var q=0;q<s.length;q++){s[q]=parseFloat(s[q])}return this.classifyWithBounds(s)},sturgesRule:function(){return Math.floor(1+3.3*Math.log(this.nbVal,10))},classify:function(s,r,i){var q=null;if(!r){r=this.sturgesRule()}switch(parseFloat(s)){case mapfish.GeoStat.Distribution.CLASSIFY_WITH_BOUNDS:q=this.classifyWithBounds(i);break;case mapfish.GeoStat.Distribution.CLASSIFY_BY_EQUAL_INTERVALS:q=this.classifyByEqIntervals(r);break;case mapfish.GeoStat.Distribution.CLASSIFY_BY_QUANTILS:q=this.classifyByQuantils(r);break;default:OpenLayers.Console.error("Unsupported or invalid classification method")}return q},CLASS_NAME:"mapfish.GeoStat.Distribution"});mapfish.GeoStat.Distribution.CLASSIFY_WITH_BOUNDS=1;mapfish.GeoStat.Distribution.CLASSIFY_BY_EQUAL_INTERVALS=2;mapfish.GeoStat.Distribution.CLASSIFY_BY_QUANTILS=3;mapfish.GeoStat.Bin=OpenLayers.Class({label:null,nbVal:null,lowerBound:null,upperBound:null,isLast:false,initialize:function(r,s,q,i){this.nbVal=r;this.lowerBound=s;this.upperBound=q;this.isLast=i},CLASS_NAME:"mapfish.GeoStat.Bin"});mapfish.GeoStat.Classification=OpenLayers.Class({bins:[],initialize:function(i){this.bins=i},getBoundsArray:function(){var r=[];for(var q=0;q<this.bins.length;q++){r.push(this.bins[q].lowerBound)}if(this.bins.length>0){r.push(this.bins[this.bins.length-1].upperBound)}return r},CLASS_NAME:"mapfish.GeoStat.Classification"});mapfish.GeoStat.Event=OpenLayers.Class(mapfish.GeoStat,{colors:[new mapfish.ColorRgb(120,120,0),new mapfish.ColorRgb(255,0,0)],method:mapfish.GeoStat.Distribution.CLASSIFY_BY_QUANTILS,numClasses:5,minSize:4,maxSize:4,minVal:null,maxVal:null,defaultSymbolizer:{fillOpacity:1},classification:null,colorInterpolation:null,gis:null,view:null,featureStore:Ext.create("Ext.data.Store",{fields:["id","name"],features:[],loadFeatures:function(r){if(r&&r.length){var s=[];for(var q=0;q<r.length;q++){s.push([r[q].attributes.id,r[q].attributes.name])}this.loadData(s);this.sortStore();this.features=r}else{this.removeAll()}},sortStore:function(){this.sort("name","ASC")}}),initialize:function(q,i){mapfish.GeoStat.prototype.initialize.apply(this,arguments)},getLoader:function(){return GIS.core.LayerLoaderEvent(this.gis,this.layer)},reset:function(){this.layer.destroyFeatures();if(this.layer.widget){this.layer.widget.reset()}},extendView:function(i,q){i=i||this.view;i.organisationUnitLevel=q.organisationUnitLevel||i.organisationUnitLevel;i.parentOrganisationUnit=q.parentOrganisationUnit||i.parentOrganisationUnit;i.parentLevel=q.parentLevel||i.parentLevel;i.parentGraph=q.parentGraph||i.parentGraph;i.opacity=q.opacity||i.opacity;return i},getLegendConfig:function(){return},getImageLegendConfig:function(){return},updateOptions:function(q){var i=OpenLayers.Util.extend({},this.options);this.addOptions(q);if(q){this.setClassification()}},createColorInterpolation:function(){var i=this.classification.bins.length;this.colorInterpolation=mapfish.ColorRgb.getColorsArrayByRgbInterpolation(this.colors[0],this.colors[1],i)},setClassification:function(){var r=[];for(var s=0;s<this.layer.features.length;s++){r.push(this.layer.features[s].attributes[this.indicator])}var q={labelGenerator:this.options.labelGenerator};var t=new mapfish.GeoStat.Distribution(r,q);this.minVal=t.minVal;this.maxVal=t.maxVal;this.classification=t.classify(this.method,this.numClasses,null);this.createColorInterpolation()},applyClassification:function(q){this.updateOptions(q);var v=OpenLayers.Function.bind(function(w){var x=w.attributes[this.indicator];var i=(x-this.minVal)/(this.maxVal-this.minVal)*(this.maxSize-this.minSize)+this.minSize;return i||this.minSize},this);this.extendStyle(null,{pointRadius:"${calculateRadius}"},{calculateRadius:v});var t=this.classification.getBoundsArray();var u=new Array(t.length-1);for(var r=0;r<t.length-1;r++){var s=new OpenLayers.Rule({symbolizer:{fillColor:this.colorInterpolation[r].toHexString()},filter:new OpenLayers.Filter.Comparison({type:OpenLayers.Filter.Comparison.BETWEEN,property:this.indicator,lowerBoundary:t[r],upperBoundary:t[r+1]})});u[r]=s}this.extendStyle(u);mapfish.GeoStat.prototype.applyClassification.apply(this,arguments)},updateLegend:function(){},CLASS_NAME:"mapfish.GeoStat.Event"});mapfish.GeoStat.Boundary=OpenLayers.Class(mapfish.GeoStat,{colors:[new mapfish.ColorRgb(120,120,0),new mapfish.ColorRgb(255,0,0)],method:mapfish.GeoStat.Distribution.CLASSIFY_BY_QUANTILS,numClasses:5,minSize:3,maxSize:20,minVal:null,maxVal:null,defaultSymbolizer:{fillOpacity:1},classification:null,colorInterpolation:null,gis:null,view:null,featureStore:Ext.create("Ext.data.Store",{fields:["id","name"],features:[],loadFeatures:function(r){if(r&&r.length){var s=[];for(var q=0;q<r.length;q++){s.push([r[q].attributes.id,r[q].attributes.name])}this.loadData(s);this.sortStore();this.features=r}else{this.removeAll()}},sortStore:function(){this.sort("name","ASC")}}),initialize:function(q,i){mapfish.GeoStat.prototype.initialize.apply(this,arguments)},getLoader:function(){return GIS.core.LayerLoaderBoundary(this.gis,this.layer)},reset:function(){this.layer.destroyFeatures();if(this.layer.widget){this.layer.widget.reset()}},extendView:function(i,q){i=i||this.view;i.organisationUnitLevel=q.organisationUnitLevel||i.organisationUnitLevel;i.parentOrganisationUnit=q.parentOrganisationUnit||i.parentOrganisationUnit;i.parentLevel=q.parentLevel||i.parentLevel;i.parentGraph=q.parentGraph||i.parentGraph;i.opacity=q.opacity||i.opacity;return i},getLegendConfig:function(){return},getImageLegendConfig:function(){return},updateOptions:function(q){var i=OpenLayers.Util.extend({},this.options);this.addOptions(q);if(q){this.setClassification()}},createColorInterpolation:function(){var i=this.classification.bins.length;this.colorInterpolation=mapfish.ColorRgb.getColorsArrayByRgbInterpolation(this.colors[0],this.colors[1],i)},setClassification:function(){var r=[];for(var s=0;s<this.layer.features.length;s++){r.push(this.layer.features[s].attributes[this.indicator])}var q={labelGenerator:this.options.labelGenerator};var t=new mapfish.GeoStat.Distribution(r,q);this.minVal=t.minVal;this.maxVal=t.maxVal;this.classification=t.classify(this.method,this.numClasses,null);this.createColorInterpolation()},applyClassification:function(q){this.updateOptions(q);var v=OpenLayers.Function.bind(function(w){var x=w.attributes[this.indicator];var i=(x-this.minVal)/(this.maxVal-this.minVal)*(this.maxSize-this.minSize)+this.minSize;return i||this.minSize},this);this.extendStyle(null,{pointRadius:"${calculateRadius}"},{calculateRadius:v});var t=this.classification.getBoundsArray();var u=new Array(t.length-1);for(var r=0;r<t.length-1;r++){var s=new OpenLayers.Rule({symbolizer:{fillColor:this.colorInterpolation[r].toHexString()},filter:new OpenLayers.Filter.Comparison({type:OpenLayers.Filter.Comparison.BETWEEN,property:this.indicator,lowerBoundary:t[r],upperBoundary:t[r+1]})});u[r]=s}this.extendStyle(u);mapfish.GeoStat.prototype.applyClassification.apply(this,arguments)},updateLegend:function(){},CLASS_NAME:"mapfish.GeoStat.Boundary"});mapfish.GeoStat.Facility=OpenLayers.Class(mapfish.GeoStat,{classification:null,gis:null,view:null,featureStore:Ext.create("Ext.data.Store",{fields:["id","name"],features:[],loadFeatures:function(r){if(r&&r.length){var s=[];for(var q=0;q<r.length;q++){s.push([r[q].attributes.id,r[q].attributes.name])}this.loadData(s);this.sortStore();this.features=r}else{this.removeAll()}},sortStore:function(){this.sort("name","ASC")}}),initialize:function(q,i){mapfish.GeoStat.prototype.initialize.apply(this,arguments)},getLoader:function(){return GIS.core.LayerLoaderFacility(this.gis,this.layer)},decode:function(v){var t,u,q,r={type:"FeatureCollection",crs:{type:"EPSG",properties:{code:"4326"}},features:[]};for(var s=0;s<v.geojson.length;s++){q=v.geojson[s];t={geometry:{type:parseInt(q.ty)===1?"MultiPolygon":"Point",coordinates:q.co},properties:{id:q.uid,internalId:q.iid,name:q.na}};t.properties=Ext.Object.merge(t.properties,q.groupSets);r.features.push(t)}return r},reset:function(){this.layer.destroyFeatures();this.layer.legendPanel.update("");this.layer.legendPanel.collapse();if(this.layer.widget){this.layer.widget.reset()}},extendView:function(i,q){i=i||this.view;i.organisationUnitGroupSet=q.organisationUnitGroupSet||i.organisationUnitGroupSet;i.organisationUnitLevel=q.organisationUnitLevel||i.organisationUnitLevel;i.parentOrganisationUnit=q.parentOrganisationUnit||i.parentOrganisationUnit;i.parentLevel=q.parentLevel||i.parentLevel;i.parentGraph=q.parentGraph||i.parentGraph;i.opacity=q.opacity||i.opacity;return i},updateOptions:function(i){this.addOptions(i)},applyClassification:function(r){this.updateOptions(r);var q=this.gis.store.groupsByGroupSet.data.items;var u=new Array(q.length);for(var s=0;s<q.length;s++){var t=new OpenLayers.Rule({symbolizer:{pointRadius:8,externalGraphic:"../../images/orgunitgroup/"+q[s].data.symbol},filter:new OpenLayers.Filter.Comparison({type:OpenLayers.Filter.Comparison.EQUAL_TO,property:this.indicator,value:q[s].data.name})});u[s]=t}this.extendStyle(u);mapfish.GeoStat.prototype.applyClassification.apply(this,arguments)},updateLegend:function(){var s=document.createElement("div"),t=document.createElement("div"),q=this.gis.store.groupsByGroupSet.data.items;for(var r=0;r<q.length;r++){t=document.createElement("div");t.style.backgroundImage="url(../../images/orgunitgroup/"+q[r].data.symbol+")";t.style.backgroundRepeat="no-repeat";t.style.width="21px";t.style.height="16px";t.style.marginBottom="2px";t.style.cssFloat="left";s.appendChild(t);t=document.createElement("div");t.innerHTML=q[r].data.name;t.style.height="16px";t.style.lineHeight="17px";s.appendChild(t);t=document.createElement("div");t.style.clear="left";s.appendChild(t)}this.layer.legendPanel.update(s.outerHTML)},CLASS_NAME:"mapfish.GeoStat.Facility"});mapfish.GeoStat.createThematic=function(i){mapfish.GeoStat[i]=OpenLayers.Class(mapfish.GeoStat,{colors:[new mapfish.ColorRgb(120,120,0),new mapfish.ColorRgb(255,0,0)],method:mapfish.GeoStat.Distribution.CLASSIFY_BY_QUANTILS,numClasses:5,bounds:null,minSize:3,maxSize:20,minVal:null,maxVal:null,defaultSymbolizer:{fillOpacity:1},classification:null,colorInterpolation:null,gis:null,view:null,featureStore:Ext.create("Ext.data.Store",{fields:["id","name"],features:[],loadFeatures:function(r){if(r&&r.length){var s=[];for(var q=0;q<r.length;q++){s.push([r[q].attributes.id,r[q].attributes.name])}this.loadData(s);this.sortStore();this.features=r}else{this.removeAll()}},sortStore:function(){this.sort("name","ASC")}}),initialize:function(r,q){mapfish.GeoStat.prototype.initialize.apply(this,arguments)},getLoader:function(){return GIS.core.LayerLoaderThematic(this.gis,this.layer)},reset:function(){this.layer.destroyFeatures();this.featureStore.loadFeatures(this.layer.features.slice(0));this.layer.legendPanel.update("");this.layer.legendPanel.collapse();if(this.layer.widget){this.layer.widget.reset()}},extendView:function(q,r){q=q||this.view;q.valueType=r.valueType||q.valueType;q.indicatorGroup=r.indicatorGroup||q.indicatorGroup;q.indicator=r.indicator||q.indicator;q.dataElementGroup=r.dataElementGroup||q.dataElementGroup;q.dataElement=r.dataElement||q.dataElement;q.periodType=r.periodType||q.periodType;q.period=r.period||q.period;q.legendType=r.legendType||q.legendType;q.legendSet=r.legendSet||q.legendSet;q.classes=r.classes||q.classes;q.method=r.method||q.method;q.colorLow=r.colorLow||q.colorLow;q.colorHigh=r.colorHigh||q.colorHigh;q.radiusLow=r.radiusLow||q.radiusLow;q.radiusHigh=r.radiusHigh||q.radiusHigh;q.organisationUnitLevel=r.organisationUnitLevel||q.organisationUnitLevel;q.parentOrganisationUnit=r.parentOrganisationUnit||q.parentOrganisationUnit;q.parentLevel=r.parentLevel||q.parentLevel;q.parentGraph=r.parentGraph||q.parentGraph;q.opacity=r.opacity||q.opacity;return q},getImageLegendConfig:function(){var t=this.classification.bins,r=this.colorInterpolation,q=[];for(var s=0;s<t.length;s++){q.push({color:r[s].toHexString(),label:t[s].lowerBound.toFixed(1)+" - "+t[s].upperBound.toFixed(1)+" ("+t[s].nbVal+")"})}return q},updateOptions:function(r){var q=OpenLayers.Util.extend({},this.options);this.addOptions(r);if(r){this.setClassification()}},createColorInterpolation:function(){var q=this.classification.bins.length;if(!this.view.legendSet){this.colorInterpolation=mapfish.ColorRgb.getColorsArrayByRgbInterpolation(this.colors[0],this.colors[1],q)}},setClassification:function(){var r=[];for(var s=0;s<this.layer.features.length;s++){r.push(this.layer.features[s].attributes[this.indicator])}var q={labelGenerator:this.options.labelGenerator};var t=new mapfish.GeoStat.Distribution(r,q);this.minVal=t.minVal;this.maxVal=t.maxVal;if(this.view.legendType===this.gis.conf.finals.widget.legendtype_predefined){if(this.bounds[0]>this.minVal){this.bounds.unshift(this.minVal);this.colorInterpolation.unshift(new mapfish.ColorRgb(240,240,240))}if(this.bounds[this.bounds.length-1]<this.maxVal){this.bounds.push(this.maxVal);this.colorInterpolation.push(new mapfish.ColorRgb(240,240,240))}}this.classification=t.classify(this.method,this.numClasses,this.bounds);this.createColorInterpolation()},applyClassification:function(q,s){this.updateOptions(q,s);var w=OpenLayers.Function.bind(function(y){var z=y.attributes[this.indicator];var x=(z-this.minVal)/(this.maxVal-this.minVal)*(this.maxSize-this.minSize)+this.minSize;return x||this.minSize},this);this.extendStyle(null,{pointRadius:"${calculateRadius}"},{calculateRadius:w});var u=this.classification.getBoundsArray();var v=new Array(u.length-1);for(var r=0;r<u.length-1;r++){var t=new OpenLayers.Rule({symbolizer:{fillColor:this.colorInterpolation[r].toHexString()},filter:new OpenLayers.Filter.Comparison({type:OpenLayers.Filter.Comparison.BETWEEN,property:this.indicator,lowerBoundary:u[r],upperBoundary:u[r+1]})});v[r]=t}this.extendStyle(v);mapfish.GeoStat.prototype.applyClassification.apply(this,arguments)},updateLegend:function(){var r=document.createElement("div"),t,s;t=document.createElement("div");t.style.height="14px";t.style.overflow="hidden";t.title=this.view.columns[0].items[0].name;t.innerHTML=this.view.columns[0].items[0].name;r.appendChild(t);t=document.createElement("div");t.style.clear="left";r.appendChild(t);t=document.createElement("div");t.style.height="14px";t.style.overflow="hidden";t.title=this.view.filters[0].items[0].name;t.innerHTML=this.view.filters[0].items[0].name;r.appendChild(t);t=document.createElement("div");t.style.clear="left";r.appendChild(t);t=document.createElement("div");t.style.width="1px";t.style.height="5px";r.appendChild(t);if(this.view.legendSet){for(var q=0;q<this.classification.bins.length;q++){t=document.createElement("div");t.style.backgroundColor=this.colorInterpolation[q].toHexString();t.style.width="30px";t.style.height=this.view.legendSet.names[q]?"25px":"20px";t.style.cssFloat="left";t.style.marginRight="8px";r.appendChild(t);t=document.createElement("div");t.style.lineHeight=this.view.legendSet.names[q]?"12px":"7px";t.innerHTML='<b style="color:#222; font-size:10px !important">'+(this.view.legendSet.names[q]||"")+"</b><br/>"+this.classification.bins[q].label;r.appendChild(t);t=document.createElement("div");t.style.clear="left";r.appendChild(t)}}else{for(var q=0;q<this.classification.bins.length;q++){t=document.createElement("div");t.style.backgroundColor=this.colorInterpolation[q].toHexString();t.style.width="30px";t.style.height="15px";t.style.cssFloat="left";t.style.marginRight="8px";r.appendChild(t);t=document.createElement("div");t.innerHTML=this.classification.bins[q].label;r.appendChild(t);t=document.createElement("div");t.style.clear="left";r.appendChild(t)}}this.layer.legendPanel.update(r.outerHTML)},CLASS_NAME:"mapfish.GeoStat."+i})};mapfish.GeoStat.createThematic("Thematic1");mapfish.GeoStat.createThematic("Thematic2");mapfish.GeoStat.createThematic("Thematic3");mapfish.GeoStat.createThematic("Thematic4")}());var g={user:{}},f=[],h=false,b=false,a,c,d;GIS.i18n={facility_layer_legend:"Facility layer legend",thematic_layer_1_legend:"Thematic layer 1 legend",thematic_layer_2_legend:"Thematic layer 2 legend",thematic_layer_3_legend:"Thematic layer 3 legend",thematic_layer_4_legend:"Thematic layer 4 legend",measure_distance:"Measure distance"};GIS.plugin={};a=function(j){var o=false,n=[],m=0,l;l=function(){if(++m===n.length){b=true;for(var p=0;p<f.length;p++){d(f[p])}f=[]}};n.push({url:j+"/api/system/context.jsonp",success:function(i){g.contextPath=i.contextPath;l()}});n.push({url:j+"/api/organisationUnits.jsonp?userOnly=true&viewClass=detailed&links=false",success:function(p){var i=p.organisationUnits[0];g.user.ou=i.id;g.user.ouc=Ext.Array.pluck(i.children,"id");l()}});n.push({url:j+"/api/mapLegendSets.jsonp?viewClass=detailed&links=false&paging=false",success:function(i){g.legendSets=i.mapLegendSets;l()}});n.push({url:j+"/api/dimensions.jsonp?links=false&paging=false",success:function(i){g.dimensions=i.dimensions;l()}});for(var k=0;k<n.length;k++){Ext.data.JsonP.request(n[k])}};c=function(){var i=".gis-plugin, .gis-plugin * { font-family: arial, sans-serif, liberation sans, consolas; } \n";i+=".x-panel-body, .x-window-body * { font-size: 11px; } \n";i+=".x-panel-header { height: 30px; padding: 7px 4px 4px 7px; border: 0 none; } \n";i+=".gis-container-default .x-window-body { padding: 5px; background: #fff; } \n";i+=".olControlPanel { position: absolute; top: 0; right: 0; border: 0 none; } \n";i+='.olControlButtonItemActive { background: #556; color: #fff; width: 24px; height: 24px; opacity: 0.75; filter: alpha(opacity=75); -ms-filter: "alpha(opacity=75)"; cursor: pointer; cursor: hand; text-align: center; font-size: 21px !important; text-shadow: 0 0 1px #ddd; } \n';i+=".olControlPanel.zoomIn { right: 72px; } \n";i+=".olControlPanel.zoomIn .olControlButtonItemActive { border-bottom-left-radius: 2px; } \n";i+=".olControlPanel.zoomOut { right: 48px; } \n";i+=".olControlPanel.zoomVisible { right: 24px; } \n";i+=".olControlPermalink { display: none !important; } \n";i+='.olControlMousePosition { background: #fff !important; opacity: 0.8 !important; filter: alpha(opacity=80) !important; -ms-filter: "alpha(opacity=80)" !important; right: 0 !important; bottom: 0 !important; border-top-left-radius: 2px !important; padding: 2px 2px 2px 5px !important; color: #000 !important; -webkit-text-stroke-width: 0.2px; -webkit-text-stroke-color: #555; } \n';i+=".olControlMousePosition * { font-size: 10px !important; } \n";i+=".text-mouseposition-lonlat { color: #555; } \n";i+=".olLayerGoogleCopyright, .olLayerGoogleV3.olLayerGooglePoweredBy { display: none; } \n";i+='#google-logo { background: url("'+g.contextPath+'/dhis-web-mapping/app/images/google-logo.png") no-repeat; width: 40px; height: 13px; margin-left: 6px; display: inline-block; vertical-align: bottom; cursor: pointer; cursor: hand; } \n';i+=".olControlScaleLine { left: 5px !important; bottom: 5px !important; } \n";i+=".olControlScaleLineBottom { display: none; } \n";i+=".olControlScaleLineTop { font-weight: bold; } \n";i+=".x-mask-msg { padding: 0; border: 0 none; background-image: none; background-color: transparent; } \n";i+=".x-mask-msg div { background-position: 11px center; } \n";i+=".x-mask-msg .x-mask-loading { border: 0 none; background-color: #000; color: #fff; border-radius: 2px; padding: 12px 14px 12px 30px; opacity: 0.65; } \n";i+=".gis-window-widget-feature { padding: 0; border: 0 none; border-radius: 0; background: transparent; box-shadow: none; } \n";i+=".gis-window-widget-feature .x-window-body-default { border: 0 none; background: transparent; } \n";i+='.gis-window-widget-feature .x-window-body-default .x-panel-body-default { border: 0 none; background: #556; opacity: 0.92; filter: alpha(opacity=92); -ms-filter: "alpha(opacity=92)"; padding: 5px 8px 5px 8px; border-bottom-left-radius: 2px; border-bottom-right-radius: 2px; color: #fff; font-weight: bold; letter-spacing: 1px; } \n';i+=".x-menu-body { border:1px solid #bbb; border-radius: 2px; padding: 0; background-color: #fff !important; } \n";i+=".x-menu-item-active .x-menu-item-link {	border-radius: 0; border-color: #e1e1e1; background-color: #e1e1e1; background-image: none; } \n";i+=".x-menu-item-link { padding: 4px 5px 4px 26px; } \n";i+=".x-menu-item-text { color: #111; } \n";i+=".disabled { opacity: 0.4; cursor: default !important; } \n";i+=".el-opacity-1 { opacity: 1 !important; } \n";i+=".el-border-0, .el-border-0 .x-panel-body { border: 0 none !important; } \n";i+=".el-fontsize-10 { font-size: 10px !important; } \n";i+=".gis-grid-row-icon-disabled * { cursor: default !important; } \n";i+=".gis-toolbar-btn-menu { margin-top: 4px; } \n";i+=".gis-toolbar-btn-menu .x-panel-body-default { border-radius: 2px; border-color: #999; } \n";i+=".gis-grid .link, .gis-grid .link * { cursor: pointer; cursor: hand; color: blue; text-decoration: underline; } \n";i+=".gis-menu-item-icon-drill, .gis-menu-item-icon-float { left: 6px; } \n";i+=".gis-menu-item-first.x-menu-item-active .x-menu-item-link {	border-radius: 0; border-top-left-radius: 2px; border-top-right-radius: 2px; } \n";i+=".gis-menu-item-last.x-menu-item-active .x-menu-item-link { border-radius: 0; border-bottom-left-radius: 2px; border-bottom-right-radius: 2px; } \n";i+='.gis-menu-item-icon-drill { \n background: url("'+g.contextPath+'/dhis-web-mapping/app/images/drill_16.png") no-repeat; } \n';i+='.gis-menu-item-icon-float { background: url("'+g.contextPath+'/dhis-web-mapping/app/images/float_16.png") no-repeat; } \n';i+=".x-color-picker a { padding: 0; } \n";i+=".x-color-picker em span { width: 14px; height: 14px; } \n";Ext.util.CSS.createStyleSheet(i)};d=function(l){var n,j,m,i,k;n=function(){if(!Ext.isString(l.url)){alert("Invalid url ("+l.el+")");return}if(l.url.split("").pop()==="/"){l.url=l.url.substr(0,l.url.length-1)}if(!Ext.isString(l.el)){alert("Invalid html element id ("+l.el+")");return}l.id=l.id||l.uid;if(l.id&&!Ext.isString(l.id)){alert("Invalid map id ("+l.el+")");return}return true};j=function(){var o,r,q,p=Ext.get(k.el);o=Ext.create("Ext.panel.Panel",{renderTo:p,width:p.getWidth(),height:p.getHeight(),cls:"gis-plugin",layout:{type:"hbox",align:"stretch"},items:[{xtype:"gx_mappanel",map:k.olmap,bodyStyle:"border:0 none",width:p.getWidth()-(k.map.hideLegend?0:200),height:p.getHeight(),listeners:{added:function(){q=this}}},{xtype:"panel",layout:"anchor",bodyStyle:"border-top:0 none; border-bottom:0 none",width:k.map.hideLegend?0:200,preventHeader:true,defaults:{bodyStyle:"padding: 6px; border: 0 none",collapsible:true,collapsed:true,animCollapse:false},items:[{title:GIS.i18n.thematic_layer_1_legend,bodyStyle:"padding:3px 0 4px 5px; border-width:1px 0 1px 0; border-color:#d0d0d0;",listeners:{added:function(){k.layer.thematic1.legendPanel=this}}},{title:GIS.i18n.thematic_layer_2_legend,bodyStyle:"padding:3px 0 4px 5px; border-width:1px 0 1px 0; border-color:#d0d0d0;",listeners:{added:function(){k.layer.thematic2.legendPanel=this}}},{title:GIS.i18n.thematic_layer_3_legend,bodyStyle:"padding:3px 0 4px 5px; border-width:1px 0 1px 0; border-color:#d0d0d0;",listeners:{added:function(){k.layer.thematic3.legendPanel=this}}},{title:GIS.i18n.thematic_layer_4_legend,bodyStyle:"padding:3px 0 4px 5px; border-width:1px 0 1px 0; border-color:#d0d0d0;",listeners:{added:function(){k.layer.thematic4.legendPanel=this}}},{title:GIS.i18n.facility_layer_legend,bodyStyle:"padding:3px 0 4px 5px; border-width:1px 0 1px 0; border-color:#d0d0d0;",listeners:{added:function(){k.layer.facility.legendPanel=this}}}],listeners:{added:function(){r=this}}}],listeners:{afterrender:function(){m()}}});o.centerRegion=q;o.eastRegion=r;return o};m=function(p){var o=Ext.query(".zoomInButton").length;for(var q=0;q<o;q++){Ext.query(".zoomInButton")[q].innerHTML='<img src="'+k.init.contextPath+'/dhis-web-mapping/app/images/zoomin_24.png" />';Ext.query(".zoomOutButton")[q].innerHTML='<img src="'+k.init.contextPath+'/dhis-web-mapping/app/images/zoomout_24.png" />';Ext.query(".zoomVisibleButton")[q].innerHTML='<img src="'+k.init.contextPath+'/dhis-web-mapping/app/images/zoomvisible_24.png" />';Ext.query(".measureButton")[q].innerHTML='<img src="'+k.init.contextPath+'/dhis-web-mapping/app/images/measure_24.png" />'}if(Ext.isDefined(k.map.baseLayer)){var r=Ext.isString(k.map.baseLayer)?k.map.baseLayer.split(" ").join("").toLowerCase():k.map.baseLayer;if(!r||r==="none"||r==="off"){k.layer.googleStreets.setVisibility(false)}else{if(r==="gh"||r==="googlehybrid"){k.olmap.setBaseLayer(k.layer.googleHybrid)}else{if(r==="osm"||r==="openstreetmap"){k.olmap.setBaseLayer(k.layer.openStreetMap)}}}}};i=function(){if(!n()){return}c();k=GIS.core.getInstance(g);k.el=l.el;GIS.core.createSelectHandlers(k,k.layer.boundary);GIS.core.createSelectHandlers(k,k.layer.thematic1);GIS.core.createSelectHandlers(k,k.layer.thematic2);GIS.core.createSelectHandlers(k,k.layer.thematic3);GIS.core.createSelectHandlers(k,k.layer.thematic4);GIS.core.createSelectHandlers(k,k.layer.facility);k.map=l;k.viewport=j();k.olmap.mask=Ext.create("Ext.LoadMask",k.viewport.centerRegion.getEl(),{msg:"Loading"});GIS.core.MapLoader(k).load()}()};GIS.plugin.getMap=function(i){if(Ext.isString(i.url)&&i.url.split("").pop()==="/"){i.url=i.url.substr(0,i.url.length-1)}if(b){d(i)}else{f.push(i);if(!h){h=true;a(i.url)}}};DHIS=Ext.isObject(window.DHIS)?DHIS:{};DHIS.getMap=GIS.plugin.getMap});
